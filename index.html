<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const SUPABASE_URL = 'https://lspjxjmbzgxtthpahfro.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzcGp4am1iemd4dHRocGFoZnJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNDI4NDQsImV4cCI6MjA4NjgxODg0NH0.jF1tjzP0qtcCqlCTyUx1jCL7LTuNW_gKJ1oPJJsvixE';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function AuthForm({ onAuthSuccess }) {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [fullName, setFullName] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
        try {
          if (isLogin) {
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
            onAuthSuccess(data.user);
          } else {
            const { data, error } = await supabase.auth.signUp({ email, password });
            if (error) throw error;
            if (data.user) {
              await supabase.from('profiles').insert({ id: data.user.id, email: data.user.email, full_name: fullName });
              onAuthSuccess(data.user);
            }
          }
        } catch (error) {
          setError(error.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <div className="text-5xl mb-4">üí∞</div>
              <h1 className="text-3xl font-bold text-gray-800">Expense Manager</h1>
              <p className="text-gray-600 mt-2">Track your income and expenses</p>
            </div>
            <form onSubmit={handleSubmit} className="space-y-4">
              {!isLogin && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                  <input type="text" value={fullName} onChange={(e) => setFullName(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required={!isLogin} />
                </div>
              )}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required minLength={6} />
              </div>
              {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm">{error}</div>}
              <button type="submit" disabled={loading}
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50 transition">
                {loading ? 'Please wait...' : (isLogin ? 'Login' : 'Sign Up')}
              </button>
            </form>
            <div className="mt-6 text-center">
              <button onClick={() => setIsLogin(!isLogin)} className="text-blue-600 hover:text-blue-700 text-sm font-medium">
                {isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login"}
              </button>
            </div>
          </div>
        </div>
      );
    }

    function Dashboard({ expenses, income }) {
      const totalIncome = income.reduce((sum, item) => sum + parseFloat(item.amount), 0);
      const totalExpenses = expenses.reduce((sum, item) => sum + parseFloat(item.amount), 0);
      const balance = totalIncome - totalExpenses;
      const now = new Date();
      const monthlyExpenses = expenses.filter(e => {
        const d = new Date(e.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      });
      const monthlyIncome = income.filter(i => {
        const d = new Date(i.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      });
      const monthlyExpenseTotal = monthlyExpenses.reduce((sum, item) => sum + parseFloat(item.amount), 0);
      const monthlyIncomeTotal = monthlyIncome.reduce((sum, item) => sum + parseFloat(item.amount), 0);

      return (
        <div className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
              <div className="flex items-center justify-between">
                <div><p className="text-gray-600 text-sm font-medium">Total Income</p>
                  <p className="text-3xl font-bold text-green-600">‚Çπ{totalIncome.toFixed(2)}</p></div>
                <div className="text-4xl">üíµ</div>
              </div>
            </div>
            <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
              <div className="flex items-center justify-between">
                <div><p className="text-gray-600 text-sm font-medium">Total Expenses</p>
                  <p className="text-3xl font-bold text-red-600">‚Çπ{totalExpenses.toFixed(2)}</p></div>
                <div className="text-4xl">üí∏</div>
              </div>
            </div>
            <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
              <div className="flex items-center justify-between">
                <div><p className="text-gray-600 text-sm font-medium">Balance</p>
                  <p className={`text-3xl font-bold ${balance >= 0 ? 'text-blue-600' : 'text-red-600'}`}>‚Çπ{balance.toFixed(2)}</p></div>
                <div className="text-4xl">üí∞</div>
              </div>
            </div>
          </div>
          <div className="bg-white rounded-xl shadow-md p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">{now.toLocaleString('default', { month: 'long', year: 'numeric' })} Summary</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-green-50 rounded-lg p-4">
                <p className="text-gray-600 text-sm">Monthly Income</p>
                <p className="text-2xl font-bold text-green-600">‚Çπ{monthlyIncomeTotal.toFixed(2)}</p>
              </div>
              <div className="bg-red-50 rounded-lg p-4">
                <p className="text-gray-600 text-sm">Monthly Expenses</p>
                <p className="text-2xl font-bold text-red-600">‚Çπ{monthlyExpenseTotal.toFixed(2)}</p>
              </div>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="bg-white rounded-xl shadow-md p-6">
              <h2 className="text-xl font-bold text-gray-800 mb-4">Recent Expenses</h2>
              <div className="space-y-3">
                {expenses.slice(0, 5).map((expense) => (
                  <div key={expense.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div className="flex items-center gap-3">
                      <span className="text-2xl">{expense.categories?.icon || 'üí∞'}</span>
                      <div><p className="font-medium text-gray-800">{expense.description}</p>
                        <p className="text-sm text-gray-600">{new Date(expense.date).toLocaleDateString()}</p></div>
                    </div>
                    <p className="font-bold text-red-600">-‚Çπ{parseFloat(expense.amount).toFixed(2)}</p>
                  </div>
                ))}
                {expenses.length === 0 && <p className="text-gray-500 text-center py-4">No expenses yet</p>}
              </div>
            </div>
            <div className="bg-white rounded-xl shadow-md p-6">
              <h2 className="text-xl font-bold text-gray-800 mb-4">Recent Income</h2>
              <div className="space-y-3">
                {income.slice(0, 5).map((inc) => (
                  <div key={inc.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div><p className="font-medium text-gray-800">{inc.source}</p>
                      <p className="text-sm text-gray-600">{new Date(inc.date).toLocaleDateString()}</p></div>
                    <p className="font-bold text-green-600">+‚Çπ{parseFloat(inc.amount).toFixed(2)}</p>
                  </div>
                ))}
                {income.length === 0 && <p className="text-gray-500 text-center py-4">No income yet</p>}
              </div>
            </div>
          </div>
        </div>
      );
    }

    function ExpensesTab({ expenses, categories, onUpdate, user }) {
      const [showForm, setShowForm] = useState(false);
      const [formData, setFormData] = useState({
        amount: '',
        description: '',
        category_id: '',
        date: new Date().toISOString().split('T')[0],
      });
      const [editingId, setEditingId] = useState(null);
      const [filterMonth, setFilterMonth] = useState('all');
      const [filterYear, setFilterYear] = useState(new Date().getFullYear().toString());

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (editingId) {
          await supabase.from('expenses').update(formData).eq('id', editingId);
        } else {
          await supabase.from('expenses').insert({ ...formData, user_id: user.id });
        }
        setFormData({ amount: '', description: '', category_id: '', date: new Date().toISOString().split('T')[0] });
        setShowForm(false);
        setEditingId(null);
        onUpdate();
      };

      const handleEdit = (expense) => {
        setFormData({
          amount: expense.amount,
          description: expense.description,
          category_id: expense.category_id,
          date: expense.date,
        });
        setEditingId(expense.id);
        setShowForm(true);
      };

      const handleDelete = async (id) => {
        if (confirm('Are you sure you want to delete this expense?')) {
          await supabase.from('expenses').delete().eq('id', id);
          onUpdate();
        }
      };

      const filteredExpenses = expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        const yearMatch = filterYear === 'all' || expenseDate.getFullYear().toString() === filterYear;
        const monthMatch = filterMonth === 'all' || expenseDate.getMonth().toString() === filterMonth;
        return yearMatch && monthMatch;
      });

      return (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold text-gray-800">Expenses</h2>
            <button onClick={() => {
              setShowForm(!showForm);
              setEditingId(null);
              setFormData({ amount: '', description: '', category_id: '', date: new Date().toISOString().split('T')[0] });
            }} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
              {showForm ? 'Cancel' : '+ Add Expense'}
            </button>
          </div>

          <div className="bg-white rounded-xl shadow-md p-4 flex gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Year</label>
              <select value={filterYear} onChange={(e) => setFilterYear(e.target.value)}
                className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="all">All Years</option>
                {[2024, 2025, 2026].map(year => <option key={year} value={year}>{year}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Month</label>
              <select value={filterMonth} onChange={(e) => setFilterMonth(e.target.value)}
                className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="all">All Months</option>
                {['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'].map((month, idx) => (
                  <option key={idx} value={idx}>{month}</option>
                ))}
              </select>
            </div>
          </div>

          {showForm && (
            <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-md p-6 space-y-4">
              <h3 className="text-xl font-bold text-gray-800">{editingId ? 'Edit Expense' : 'Add New Expense'}</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Amount (‚Çπ) *</label>
                  <input type="number" step="0.01" value={formData.amount}
                    onChange={(e) => setFormData({ ...formData, amount: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required placeholder="Enter amount" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                  <select value={formData.category_id}
                    onChange={(e) => setFormData({ ...formData, category_id: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required>
                    <option value="">Select Category</option>
                    {categories.map((cat) => (
                      <option key={cat.id} value={cat.id}>{cat.icon} {cat.name}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Description *</label>
                  <input type="text" value={formData.description}
                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required placeholder="e.g., Lunch at restaurant" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                  <input type="date" value={formData.date}
                    onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required />
                </div>
              </div>
              <button type="submit"
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                {editingId ? 'Update Expense' : 'Add Expense'}
              </button>
            </form>
          )}

          <div className="bg-white rounded-xl shadow-md overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50 border-b">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {filteredExpenses.map((expense) => (
                    <tr key={expense.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {new Date(expense.date).toLocaleDateString()}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm">
                        <span className="inline-flex items-center gap-2">
                          <span>{expense.categories?.icon}</span>
                          <span style={{ color: expense.categories?.color }}>{expense.categories?.name}</span>
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-900">{expense.description}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-600">
                        ‚Çπ{parseFloat(expense.amount).toFixed(2)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm">
                        <button onClick={() => handleEdit(expense)} className="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                        <button onClick={() => handleDelete(expense.id)} className="text-red-600 hover:text-red-800">Delete</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {filteredExpenses.length === 0 && (
                <div className="text-center py-12 text-gray-500">No expenses found</div>
              )}
            </div>
          </div>
        </div>
      );
    }

    function IncomeTab({ income, onUpdate, user }) {
      const [showForm, setShowForm] = useState(false);
      const [formData, setFormData] = useState({
        amount: '',
        source: '',
        description: '',
        date: new Date().toISOString().split('T')[0],
      });
      const [editingId, setEditingId] = useState(null);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (editingId) {
          await supabase.from('income').update(formData).eq('id', editingId);
        } else {
          await supabase.from('income').insert({ ...formData, user_id: user.id });
        }
        setFormData({ amount: '', source: '', description: '', date: new Date().toISOString().split('T')[0] });
        setShowForm(false);
        setEditingId(null);
        onUpdate();
      };

      const handleEdit = (inc) => {
        setFormData({
          amount: inc.amount,
          source: inc.source,
          description: inc.description || '',
          date: inc.date,
        });
        setEditingId(inc.id);
        setShowForm(true);
      };

      const handleDelete = async (id) => {
        if (confirm('Are you sure you want to delete this income?')) {
          await supabase.from('income').delete().eq('id', id);
          onUpdate();
        }
      };

      return (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold text-gray-800">Income / Pocket Money</h2>
            <button onClick={() => {
              setShowForm(!showForm);
              setEditingId(null);
              setFormData({ amount: '', source: '', description: '', date: new Date().toISOString().split('T')[0] });
            }} className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
              {showForm ? 'Cancel' : '+ Add Income'}
            </button>
          </div>

          {showForm && (
            <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-md p-6 space-y-4">
              <h3 className="text-xl font-bold text-gray-800">{editingId ? 'Edit Income' : 'Add New Income'}</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Amount (‚Çπ) *</label>
                  <input type="number" step="0.01" value={formData.amount}
                    onChange={(e) => setFormData({ ...formData, amount: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                    required placeholder="Enter amount" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Source *</label>
                  <input type="text" value={formData.source}
                    onChange={(e) => setFormData({ ...formData, source: e.target.value })}
                    placeholder="e.g., Salary, Pocket Money, Gift"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                    required />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                  <input type="text" value={formData.description}
                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                    placeholder="Additional details" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                  <input type="date" value={formData.date}
                    onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                    required />
                </div>
              </div>
              <button type="submit"
                className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                {editingId ? 'Update Income' : 'Add Income'}
              </button>
            </form>
          )}

          <div className="bg-white rounded-xl shadow-md overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50 border-b">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {income.map((inc) => (
                    <tr key={inc.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {new Date(inc.date).toLocaleDateString()}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{inc.source}</td>
                      <td className="px-6 py-4 text-sm text-gray-600">{inc.description || '-'}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-600">
                        ‚Çπ{parseFloat(inc.amount).toFixed(2)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm">
                        <button onClick={() => handleEdit(inc)} className="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                        <button onClick={() => handleDelete(inc.id)} className="text-red-600 hover:text-red-800">Delete</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {income.length === 0 && (
                <div className="text-center py-12 text-gray-500">No income records found</div>
              )}
            </div>
          </div>
        </div>
      );
    }

    function CategoriesTab({ categories, onUpdate, user }) {
      const [showForm, setShowForm] = useState(false);
      const [formData, setFormData] = useState({ name: '', icon: 'üí∞', color: '#3B82F6' });
      const [editingId, setEditingId] = useState(null);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (editingId) {
          await supabase.from('categories').update(formData).eq('id', editingId);
        } else {
          await supabase.from('categories').insert({ ...formData, user_id: user.id });
        }
        setFormData({ name: '', icon: 'üí∞', color: '#3B82F6' });
        setShowForm(false);
        setEditingId(null);
        onUpdate();
      };

      const handleEdit = (cat) => {
        setFormData({ name: cat.name, icon: cat.icon, color: cat.color });
        setEditingId(cat.id);
        setShowForm(true);
      };

      const handleDelete = async (id) => {
        if (confirm('Are you sure? Expenses with this category will have no category.')) {
          await supabase.from('categories').delete().eq('id', id);
          onUpdate();
        }
      };

      const commonIcons = ['üçî', 'üöó', 'üéÆ', 'üõçÔ∏è', 'üìÑ', 'üíä', 'üìö', 'üè†', '‚úàÔ∏è', 'üé¨', 'üí∞', 'üé®'];

      return (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold text-gray-800">Categories</h2>
            <button onClick={() => {
              setShowForm(!showForm);
              setEditingId(null);
              setFormData({ name: '', icon: 'üí∞', color: '#3B82F6' });
            }} className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
              {showForm ? 'Cancel' : '+ Add Category'}
            </button>
          </div>

          {showForm && (
            <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-md p-6 space-y-4">
              <h3 className="text-xl font-bold text-gray-800">{editingId ? 'Edit Category' : 'Add New Category'}</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                  <input type="text" value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    required placeholder="e.g., Groceries" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Icon *</label>
                  <div className="flex gap-2">
                    <input type="text" value={formData.icon}
                      onChange={(e) => setFormData({ ...formData, icon: e.target.value })}
                      className="w-20 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-center text-2xl"
                      required />
                    <div className="flex flex-wrap gap-1">
                      {commonIcons.slice(0, 6).map(icon => (
                        <button key={icon} type="button"
                          onClick={() => setFormData({ ...formData, icon })}
                          className="text-2xl hover:bg-gray-100 rounded px-1">
                          {icon}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Color *</label>
                  <input type="color" value={formData.color}
                    onChange={(e) => setFormData({ ...formData, color: e.target.value })}
                    className="w-full h-10 px-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    required />
                </div>
              </div>
              <button type="submit"
                className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition">
                {editingId ? 'Update Category' : 'Add Category'}
              </button>
            </form>
          )}

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {categories.map((cat) => (
              <div key={cat.id} className="bg-white rounded-xl shadow-md p-6 border-l-4" style={{ borderColor: cat.color }}>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <span className="text-4xl">{cat.icon}</span>
                    <div>
                      <h3 className="font-bold text-lg" style={{ color: cat.color }}>{cat.name}</h3>
                      <p className="text-sm text-gray-500">{cat.color}</p>
                    </div>
                  </div>
                  <div className="flex flex-col gap-2">
                    <button onClick={() => handleEdit(cat)} className="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                    <button onClick={() => handleDelete(cat.id)} className="text-red-600 hover:text-red-800 text-sm">Delete</button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function Statistics({ expenses, income, categories }) {
      const chartRef = useRef(null);
      const pieChartRef = useRef(null);
      const [chartInstance, setChartInstance] = useState(null);
      const [pieChartInstance, setPieChartInstance] = useState(null);

      useEffect(() => {
        if (chartRef.current && expenses.length > 0) {
          if (chartInstance) chartInstance.destroy();
          createLineChart();
        }
        return () => { if (chartInstance) chartInstance.destroy(); };
      }, [expenses, income]);

      useEffect(() => {
        if (pieChartRef.current && expenses.length > 0) {
          if (pieChartInstance) pieChartInstance.destroy();
          createPieChart();
        }
        return () => { if (pieChartInstance) pieChartInstance.destroy(); };
      }, [expenses]);

      const createLineChart = () => {
        const ctx = chartRef.current.getContext('2d');
        const expensesByDate = {};
        const incomeByDate = {};
        
        expenses.forEach(e => {
          const date = e.date;
          expensesByDate[date] = (expensesByDate[date] || 0) + parseFloat(e.amount);
        });
        
        income.forEach(i => {
          const date = i.date;
          incomeByDate[date] = (incomeByDate[date] || 0) + parseFloat(i.amount);
        });

        const allDates = [...new Set([...Object.keys(expensesByDate), ...Object.keys(incomeByDate)])].sort();
        
        const chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: allDates.map(d => new Date(d).toLocaleDateString()),
            datasets: [
              {
                label: 'Expenses',
                data: allDates.map(d => expensesByDate[d] || 0),
                borderColor: '#EF4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
              },
              {
                label: 'Income',
                data: allDates.map(d => incomeByDate[d] || 0),
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true, position: 'top' } },
            scales: { y: { beginAtZero: true } },
          },
        });
        setChartInstance(chart);
      };

      const createPieChart = () => {
        const ctx = pieChartRef.current.getContext('2d');
        const expensesByCategory = {};
        expenses.forEach(e => {
          const catName = e.categories?.name || 'Uncategorized';
          const catColor = e.categories?.color || '#6B7280';
          if (!expensesByCategory[catName]) {
            expensesByCategory[catName] = { amount: 0, color: catColor };
          }
          expensesByCategory[catName].amount += parseFloat(e.amount);
        });

        const labels = Object.keys(expensesByCategory);
        const data = labels.map(l => expensesByCategory[l].amount);
        const colors = labels.map(l => expensesByCategory[l].color);

        const chart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{ data, backgroundColor: colors }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true, position: 'right' } },
          },
        });
        setPieChartInstance(chart);
      };

      const totalIncome = income.reduce((sum, i) => sum + parseFloat(i.amount), 0);
      const totalExpenses = expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
      const categoryStats = {};
      expenses.forEach(e => {
        const catName = e.categories?.name || 'Uncategorized';
        if (!categoryStats[catName]) {
          categoryStats[catName] = { amount: 0, count: 0, color: e.categories?.color || '#6B7280', icon: e.categories?.icon || 'üí∞' };
        }
        categoryStats[catName].amount += parseFloat(e.amount);
        categoryStats[catName].count += 1;
      });
      const sortedCategories = Object.entries(categoryStats).sort((a, b) => b[1].amount - a[1].amount);

      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold text-gray-800">Statistics & Analytics</h2>
          {expenses.length === 0 ? (
            <div className="bg-white rounded-xl shadow-md p-12 text-center">
              <p className="text-gray-500 text-lg">No data yet. Add some expenses to see statistics!</p>
            </div>
          ) : (
            <>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-white rounded-xl shadow-md p-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">Income vs Expenses Trend</h3>
                  <div style={{ height: '300px' }}><canvas ref={chartRef}></canvas></div>
                </div>
                <div className="bg-white rounded-xl shadow-md p-6">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">Expenses by Category</h3>
                  <div style={{ height: '300px' }}><canvas ref={pieChartRef}></canvas></div>
                </div>
              </div>
              <div className="bg-white rounded-xl shadow-md p-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4">Category Breakdown</h3>
                <div className="space-y-3">
                  {sortedCategories.map(([name, stats]) => (
                    <div key={name} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                      <div className="flex items-center gap-3">
                        <span className="text-2xl">{stats.icon}</span>
                        <div>
                          <p className="font-medium" style={{ color: stats.color }}>{name}</p>
                          <p className="text-sm text-gray-600">{stats.count} transactions</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="font-bold text-red-600">‚Çπ{stats.amount.toFixed(2)}</p>
                        <p className="text-sm text-gray-600">{((stats.amount / totalExpenses) * 100).toFixed(1)}%</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-white rounded-xl shadow-md p-6">
                  <p className="text-gray-600 text-sm mb-2">Average Expense</p>
                  <p className="text-2xl font-bold text-gray-800">
                    ‚Çπ{expenses.length > 0 ? (totalExpenses / expenses.length).toFixed(2) : '0.00'}
                  </p>
                </div>
                <div className="bg-white rounded-xl shadow-md p-6">
                  <p className="text-gray-600 text-sm mb-2">Largest Expense</p>
                  <p className="text-2xl font-bold text-gray-800">
                    ‚Çπ{expenses.length > 0 ? Math.max(...expenses.map(e => parseFloat(e.amount))).toFixed(2) : '0.00'}
                  </p>
                </div>
                <div className="bg-white rounded-xl shadow-md p-6">
                  <p className="text-gray-600 text-sm mb-2">Savings Rate</p>
                  <p className="text-2xl font-bold text-gray-800">
                    {totalIncome > 0 ? (((totalIncome - totalExpenses) / totalIncome) * 100).toFixed(1) : '0'}%
                  </p>
                </div>
              </div>
            </>
          )}
        </div>
      );
    }

    function ExpenseManager() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [activeTab, setActiveTab] = useState('dashboard');
      const [expenses, setExpenses] = useState([]);
      const [income, setIncome] = useState([]);
      const [categories, setCategories] = useState([]);

      useEffect(() => { checkUser(); }, []);
      useEffect(() => { if (user) loadData(); }, [user]);

      const checkUser = async () => {
        const { data: { session } } = await supabase.auth.getSession();
        setUser(session?.user ?? null);
        setLoading(false);
      };

      const loadData = async () => {
        await Promise.all([loadExpenses(), loadIncome(), loadCategories()]);
      };

      const loadExpenses = async () => {
        const { data } = await supabase.from('expenses').select('*, categories(name, color, icon)').order('date', { ascending: false });
        setExpenses(data || []);
      };

      const loadIncome = async () => {
        const { data } = await supabase.from('income').select('*').order('date', { ascending: false });
        setIncome(data || []);
      };

      const loadCategories = async () => {
        const { data } = await supabase.from('categories').select('*').order('name');
        if (data && data.length > 0) {
          setCategories(data);
        } else {
          const defaults = [
            { name: 'Food', icon: 'üçî', color: '#EF4444' }, { name: 'Transport', icon: 'üöó', color: '#3B82F6' },
            { name: 'Entertainment', icon: 'üéÆ', color: '#8B5CF6' }, { name: 'Shopping', icon: 'üõçÔ∏è', color: '#EC4899' },
            { name: 'Bills', icon: 'üìÑ', color: '#F59E0B' }, { name: 'Health', icon: 'üíä', color: '#10B981' },
            { name: 'Education', icon: 'üìö', color: '#6366F1' }, { name: 'Others', icon: 'üí∞', color: '#6B7280' }
          ];
          for (const cat of defaults) await supabase.from('categories').insert({ user_id: user.id, ...cat });
          loadCategories();
        }
      };

      const handleLogout = async () => { await supabase.auth.signOut(); setUser(null); };

      if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="text-2xl">Loading...</div></div>;
      if (!user) return <AuthForm onAuthSuccess={setUser} />;

      return (
        <div className="min-h-screen bg-gray-50">
          <header className="bg-white shadow-sm border-b">
            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
              <div className="flex items-center gap-2">
                <span className="text-3xl">üí∞</span>
                <h1 className="text-2xl font-bold text-gray-800">Expense Manager</h1>
              </div>
              <button onClick={handleLogout} className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">Logout</button>
            </div>
          </header>
          <nav className="bg-white border-b">
            <div className="max-w-7xl mx-auto px-4">
              <div className="flex gap-1">
                {['dashboard', 'expenses', 'income', 'categories', 'statistics'].map((tab) => (
                  <button key={tab} onClick={() => setActiveTab(tab)}
                    className={`px-6 py-3 font-medium capitalize transition ${
                      activeTab === tab ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 hover:text-gray-800'
                    }`}>
                    {tab}
                  </button>
                ))}
              </div>
            </div>
          </nav>
          <main className="max-w-7xl mx-auto px-4 py-8">
            {activeTab === 'dashboard' && <Dashboard expenses={expenses} income={income} />}
            {activeTab === 'expenses' && <ExpensesTab expenses={expenses} categories={categories} onUpdate={loadExpenses} user={user} />}
            {activeTab === 'income' && <IncomeTab income={income} onUpdate={loadIncome} user={user} />}
            {activeTab === 'categories' && <CategoriesTab categories={categories} onUpdate={loadCategories} user={user} />}
            {activeTab === 'statistics' && <Statistics expenses={expenses} income={income} categories={categories} />}
          </main>
        </div>
      );
    }

    ReactDOM.render(<ExpenseManager />, document.getElementById('root'));
  </script>
</body>
</html>
