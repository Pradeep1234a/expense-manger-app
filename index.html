<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PaisaPlay ‚Äî Student Money OS</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg: #0a0a0f;
  --bg2: #111118;
  --bg3: #1a1a28;
  --card: #16161f;
  --card2: #1e1e2e;
  --border: #2a2a3e;
  --border2: #3a3a55;
  --text: #e8e8f0;
  --text2: #9090b0;
  --text3: #6060808;
  --accent: #7c3aed;
  --accent2: #a855f7;
  --accent3: #c084fc;
  --green: #10b981;
  --green2: #34d399;
  --yellow: #f59e0b;
  --red: #ef4444;
  --red2: #f87171;
  --blue: #3b82f6;
  --cyan: #06b6d4;
  --pink: #ec4899;
  --orange: #f97316;
  --glow: 0 0 30px rgba(124,58,237,0.3);
  --glow-green: 0 0 20px rgba(16,185,129,0.3);
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --radius: 16px;
  --radius2: 12px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* NOISE TEXTURE OVERLAY */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
  opacity: 0.4;
}

h1, h2, h3, h4 { font-family: 'Syne', sans-serif; }
.mono { font-family: 'Space Mono', monospace; }

/* ===== AUTH SCREEN ===== */
#auth-screen {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: radial-gradient(ellipse at 20% 50%, rgba(124,58,237,0.15) 0%, transparent 50%),
              radial-gradient(ellipse at 80% 20%, rgba(6,182,212,0.1) 0%, transparent 50%),
              var(--bg);
  padding: 20px;
}

.auth-container {
  width: 100%;
  max-width: 440px;
}

.auth-logo {
  text-align: center;
  margin-bottom: 40px;
}

.auth-logo .logo-icon {
  font-size: 56px;
  display: block;
  margin-bottom: 12px;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

.auth-logo h1 {
  font-size: 36px;
  font-weight: 800;
  background: linear-gradient(135deg, #a855f7, #06b6d4);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -1px;
}

.auth-logo p {
  color: var(--text2);
  margin-top: 6px;
  font-size: 14px;
}

.auth-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 36px;
  box-shadow: var(--shadow), 0 0 60px rgba(124,58,237,0.08);
}

.auth-tabs {
  display: flex;
  gap: 4px;
  background: var(--bg);
  border-radius: 12px;
  padding: 4px;
  margin-bottom: 28px;
}

.auth-tab {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 9px;
  background: transparent;
  color: var(--text2);
  font-family: 'Syne', sans-serif;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.auth-tab.active {
  background: var(--accent);
  color: white;
  box-shadow: 0 2px 12px rgba(124,58,237,0.4);
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 8px;
}

.form-group input, .form-group select, .form-group textarea {
  width: 100%;
  padding: 13px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  transition: all 0.2s;
  outline: none;
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(124,58,237,0.15);
}

.form-group input::placeholder { color: var(--text2); opacity: 0.6; }

.btn-primary {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border: none;
  border-radius: 12px;
  color: white;
  font-family: 'Syne', sans-serif;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.btn-primary::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, transparent, rgba(255,255,255,0.1));
  opacity: 0;
  transition: opacity 0.2s;
}

.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(124,58,237,0.5); }
.btn-primary:hover::after { opacity: 1; }
.btn-primary:active { transform: translateY(0); }

.auth-error {
  background: rgba(239,68,68,0.1);
  border: 1px solid rgba(239,68,68,0.3);
  border-radius: 10px;
  padding: 12px 16px;
  color: var(--red2);
  font-size: 14px;
  margin-bottom: 16px;
  display: none;
}

/* ===== MAIN APP ===== */
#app { display: none; min-height: 100vh; }

/* TOP NAV */
.topnav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
  background: rgba(10,10,15,0.85);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.nav-logo {
  font-family: 'Syne', sans-serif;
  font-size: 22px;
  font-weight: 800;
  background: linear-gradient(135deg, #a855f7, #06b6d4);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.nav-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.xp-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 13px;
  font-weight: 600;
}

.xp-pill .level-badge {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius: 50%;
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
}

.streak-pill {
  display: flex;
  align-items: center;
  gap: 4px;
  color: var(--orange);
  font-size: 14px;
  font-weight: 700;
}

.avatar-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--cyan));
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

/* BOTTOM NAV */
.bottomnav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 100;
  background: rgba(10,10,15,0.95);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  display: flex;
  padding: 8px 0;
  padding-bottom: env(safe-area-inset-bottom, 8px);
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 6px;
  border: none;
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
}

.nav-item.active { color: var(--accent2); }
.nav-item .nav-icon { font-size: 22px; }
.nav-item .nav-label { font-size: 10px; font-weight: 600; font-family: 'Syne', sans-serif; }

/* MAIN CONTENT */
.main-content {
  padding-top: 60px;
  padding-bottom: 80px;
  min-height: 100vh;
}

/* PAGES */
.page { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
.page.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* CARDS */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
}

.card-sm {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius2);
  padding: 16px;
}

/* HERO BALANCE CARD */
.balance-hero {
  background: linear-gradient(135deg, #1a0a35 0%, #0d1a30 50%, #0a1a1a 100%);
  border: 1px solid var(--border2);
  border-radius: 24px;
  padding: 28px 24px;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
}

.balance-hero::before {
  content: '';
  position: absolute;
  top: -60px;
  right: -60px;
  width: 200px;
  height: 200px;
  background: radial-gradient(circle, rgba(124,58,237,0.3) 0%, transparent 70%);
  border-radius: 50%;
}

.balance-hero::after {
  content: '';
  position: absolute;
  bottom: -40px;
  left: 40px;
  width: 120px;
  height: 120px;
  background: radial-gradient(circle, rgba(6,182,212,0.2) 0%, transparent 70%);
  border-radius: 50%;
}

.balance-label {
  font-size: 12px;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 600;
  margin-bottom: 8px;
}

.balance-amount {
  font-family: 'Syne', sans-serif;
  font-size: 44px;
  font-weight: 800;
  color: white;
  line-height: 1;
  margin-bottom: 16px;
  position: relative;
  z-index: 1;
}

.balance-amount .currency { font-size: 24px; color: var(--accent3); }

.balance-row {
  display: flex;
  gap: 16px;
  position: relative;
  z-index: 1;
}

.balance-stat {
  flex: 1;
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 12px;
  text-align: center;
}

.balance-stat .stat-val {
  font-family: 'Syne', sans-serif;
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 2px;
}

.balance-stat .stat-lbl {
  font-size: 11px;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* SURVIVAL METER */
.survival-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
}

.survival-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.risk-badge {
  padding: 5px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  font-family: 'Syne', sans-serif;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.risk-safe { background: rgba(16,185,129,0.2); color: var(--green2); border: 1px solid rgba(16,185,129,0.3); }
.risk-warning { background: rgba(245,158,11,0.2); color: var(--yellow); border: 1px solid rgba(245,158,11,0.3); }
.risk-critical { background: rgba(239,68,68,0.2); color: var(--red2); border: 1px solid rgba(239,68,68,0.3); animation: pulse-red 1.5s ease-in-out infinite; }

@keyframes pulse-red {
  0%,100% { box-shadow: none; }
  50% { box-shadow: 0 0 12px rgba(239,68,68,0.4); }
}

.progress-bar-bg {
  background: var(--bg);
  border-radius: 20px;
  height: 10px;
  overflow: hidden;
  margin-bottom: 12px;
}

.progress-bar-fill {
  height: 100%;
  border-radius: 20px;
  transition: width 1s ease;
}

.survival-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.surv-stat {
  text-align: center;
  background: var(--bg);
  border-radius: 10px;
  padding: 10px 6px;
}

.surv-stat .val {
  font-family: 'Space Mono', monospace;
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}

.surv-stat .lbl {
  font-size: 10px;
  color: var(--text2);
  margin-top: 2px;
}

/* QUICK ACTIONS */
.quick-actions {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin-bottom: 16px;
}

.qa-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius2);
  padding: 14px 8px;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  color: var(--text);
}

.qa-btn:hover {
  border-color: var(--accent);
  background: rgba(124,58,237,0.1);
  transform: translateY(-2px);
}

.qa-icon { font-size: 24px; }
.qa-label { font-size: 11px; font-weight: 600; font-family: 'Syne', sans-serif; text-align: center; color: var(--text2); }

/* SECTION HEADERS */
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.section-title {
  font-family: 'Syne', sans-serif;
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
}

.section-link {
  font-size: 13px;
  color: var(--accent2);
  cursor: pointer;
  background: none;
  border: none;
  font-family: 'DM Sans', sans-serif;
}

/* RECENT EXPENSES */
.expense-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 0;
  border-bottom: 1px solid var(--border);
}

.expense-item:last-child { border-bottom: none; }

.expense-icon {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}

.expense-info { flex: 1; min-width: 0; }
.expense-name { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.expense-meta { font-size: 12px; color: var(--text2); margin-top: 2px; }
.expense-amount { font-family: 'Space Mono', monospace; font-weight: 700; font-size: 15px; color: var(--red2); white-space: nowrap; }

/* CATEGORY COLORS */
.cat-food { background: rgba(245,158,11,0.15); }
.cat-rent { background: rgba(59,130,246,0.15); }
.cat-travel { background: rgba(16,185,129,0.15); }
.cat-education { background: rgba(139,92,246,0.15); }
.cat-shopping { background: rgba(236,72,153,0.15); }
.cat-entertainment { background: rgba(249,115,22,0.15); }
.cat-health { background: rgba(6,182,212,0.15); }
.cat-other { background: rgba(100,116,139,0.15); }
.cat-subscription { background: rgba(239,68,68,0.15); }

/* HEALTH SCORE RING */
.health-score-container {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 20px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 16px;
}

.score-ring {
  position: relative;
  width: 90px;
  height: 90px;
  flex-shrink: 0;
}

.score-ring svg { transform: rotate(-90deg); }

.score-ring .score-text {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.score-number {
  font-family: 'Syne', sans-serif;
  font-size: 22px;
  font-weight: 800;
}

.score-label { font-size: 9px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }

.health-info h3 {
  font-family: 'Syne', sans-serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 6px;
}

.health-info p { font-size: 13px; color: var(--text2); line-height: 1.5; }

/* MODAL */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(6px);
  z-index: 200;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

.modal-overlay.open {
  opacity: 1;
  pointer-events: all;
}

.modal {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 24px 24px 0 0;
  padding: 28px 24px;
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  transform: translateY(100%);
  transition: transform 0.3s ease;
}

.modal-overlay.open .modal {
  transform: translateY(0);
}

.modal-handle {
  width: 40px;
  height: 4px;
  background: var(--border2);
  border-radius: 2px;
  margin: 0 auto 20px;
}

.modal-title {
  font-family: 'Syne', sans-serif;
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 24px;
}

/* AMOUNT CATEGORIES GRID */
.category-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-bottom: 16px;
}

.cat-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 12px 6px;
  border: 2px solid var(--border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  background: none;
  color: var(--text);
}

.cat-option:hover { border-color: var(--accent); background: rgba(124,58,237,0.1); }
.cat-option.selected { border-color: var(--accent); background: rgba(124,58,237,0.15); }
.cat-option .cat-emoji { font-size: 22px; }
.cat-option .cat-name { font-size: 10px; font-weight: 600; color: var(--text2); text-align: center; font-family: 'Syne', sans-serif; }

/* MOOD SELECTOR */
.mood-row {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  overflow-x: auto;
  padding-bottom: 4px;
}

.mood-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 10px 14px;
  border: 2px solid var(--border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  background: none;
  color: var(--text);
  flex-shrink: 0;
  min-width: 60px;
}

.mood-btn.selected { border-color: var(--accent); background: rgba(124,58,237,0.1); }
.mood-btn span:first-child { font-size: 20px; }
.mood-btn span:last-child { font-size: 10px; font-weight: 600; color: var(--text2); }

/* GAMIFICATION PAGE */
.level-card {
  background: linear-gradient(135deg, #1a0a35, #0d1a30);
  border: 1px solid var(--border2);
  border-radius: 24px;
  padding: 24px;
  margin-bottom: 16px;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.level-card::before {
  content: '';
  position: absolute;
  top: -40px;
  left: 50%;
  transform: translateX(-50%);
  width: 180px;
  height: 180px;
  background: radial-gradient(circle, rgba(124,58,237,0.3) 0%, transparent 70%);
}

.level-emoji { font-size: 60px; margin-bottom: 12px; display: block; position: relative; z-index: 1; animation: float 3s ease-in-out infinite; }
.level-name { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; margin-bottom: 6px; position: relative; z-index: 1; }
.level-sub { font-size: 14px; color: var(--text2); margin-bottom: 20px; position: relative; z-index: 1; }

.xp-bar-container { position: relative; z-index: 1; }
.xp-bar-label { display: flex; justify-content: space-between; font-size: 12px; color: var(--text2); margin-bottom: 8px; }

.xp-bar-bg {
  background: rgba(0,0,0,0.4);
  border-radius: 20px;
  height: 12px;
  overflow: hidden;
}

.xp-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2), var(--cyan));
  border-radius: 20px;
  transition: width 1.5s ease;
  position: relative;
}

.xp-bar-fill::after {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  width: 20px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4));
  animation: shimmer 2s infinite;
}

@keyframes shimmer { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

/* BADGES GRID */
.badges-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 16px;
}

.badge-item {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius2);
  padding: 16px 10px;
  text-align: center;
  transition: all 0.2s;
}

.badge-item.earned {
  border-color: var(--accent);
  background: rgba(124,58,237,0.1);
}

.badge-item.locked { opacity: 0.4; filter: grayscale(1); }

.badge-emoji { font-size: 32px; display: block; margin-bottom: 8px; }
.badge-name { font-size: 11px; font-weight: 600; font-family: 'Syne', sans-serif; color: var(--text2); }

/* STREAK DISPLAY */
.streak-display {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  background: linear-gradient(135deg, rgba(249,115,22,0.1), rgba(245,158,11,0.1));
  border: 1px solid rgba(249,115,22,0.2);
  border-radius: 20px;
  padding: 20px;
  margin-bottom: 16px;
}

.streak-num {
  font-family: 'Syne', sans-serif;
  font-size: 56px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--orange), var(--yellow));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  line-height: 1;
}

.streak-info h3 { font-family: 'Syne', sans-serif; font-size: 18px; margin-bottom: 4px; }
.streak-info p { font-size: 13px; color: var(--text2); }

/* CHALLENGES */
.challenge-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  margin-bottom: 12px;
}

.challenge-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
.challenge-title { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; }
.challenge-desc { font-size: 13px; color: var(--text2); margin-top: 3px; }
.challenge-days { font-size: 12px; color: var(--accent2); font-weight: 600; }

/* AI CHAT */
.chat-container {
  height: calc(100vh - 200px);
  display: flex;
  flex-direction: column;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px 0;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.chat-bubble {
  max-width: 85%;
  padding: 14px 16px;
  border-radius: 20px;
  font-size: 14px;
  line-height: 1.6;
  animation: bubbleIn 0.3s ease;
}

@keyframes bubbleIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.chat-bubble.user {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 6px;
}

.chat-bubble.assistant {
  background: var(--card2);
  border: 1px solid var(--border);
  color: var(--text);
  align-self: flex-start;
  border-bottom-left-radius: 6px;
}

.chat-input-row {
  display: flex;
  gap: 10px;
  padding: 16px 0 0;
  border-top: 1px solid var(--border);
  align-items: flex-end;
}

.chat-input {
  flex: 1;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 12px 16px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  resize: none;
  outline: none;
  max-height: 120px;
}

.chat-input:focus { border-color: var(--accent); }

.chat-send {
  width: 46px;
  height: 46px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border: none;
  border-radius: 14px;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
  transition: all 0.2s;
}

.chat-send:hover { transform: scale(1.05); }

.chat-mode-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  overflow-x: auto;
  padding-bottom: 4px;
}

.chat-mode-btn {
  padding: 8px 16px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
  font-family: 'Syne', sans-serif;
}

.chat-mode-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

/* GAMES */
.games-grid {
  display: grid;
  grid-template-columns: repeat(1, 1fr);
  gap: 14px;
  margin-bottom: 16px;
}

.game-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.game-card::before {
  content: '';
  position: absolute;
  inset: 0;
  opacity: 0;
  transition: opacity 0.2s;
}

.game-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
.game-card:hover::before { opacity: 1; }

.game-card-header { display: flex; align-items: center; gap: 14px; margin-bottom: 12px; }
.game-emoji { font-size: 40px; }
.game-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; }
.game-desc { font-size: 13px; color: var(--text2); margin-top: 2px; }

.game-meta { display: flex; justify-content: space-between; align-items: center; }
.high-score { font-family: 'Space Mono', monospace; font-size: 14px; color: var(--yellow); }

.play-btn {
  padding: 8px 20px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border: none;
  border-radius: 20px;
  color: white;
  font-family: 'Syne', sans-serif;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.play-btn:hover { transform: scale(1.05); }

/* GAME CANVAS */
.game-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 300;
  display: none;
  flex-direction: column;
}

.game-overlay.open { display: flex; }

.game-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}

.game-header h2 { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; }

.close-game {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--card);
  border: 1px solid var(--border);
  color: var(--text);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

#game-canvas-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

canvas {
  border-radius: 16px;
  border: 1px solid var(--border);
  max-width: 100%;
  touch-action: none;
}

/* ANALYTICS */
.chart-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
}

.chart-card h3 {
  font-family: 'Syne', sans-serif;
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 16px;
}

/* HEATMAP */
.heatmap-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.heatmap-cell {
  aspect-ratio: 1;
  border-radius: 4px;
  background: var(--bg);
  transition: all 0.2s;
}

.heatmap-cell.h1 { background: rgba(124,58,237,0.2); }
.heatmap-cell.h2 { background: rgba(124,58,237,0.4); }
.heatmap-cell.h3 { background: rgba(124,58,237,0.6); }
.heatmap-cell.h4 { background: rgba(124,58,237,0.9); }

/* LEADERBOARD */
.leaderboard-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 0;
  border-bottom: 1px solid var(--border);
}

.leaderboard-rank {
  font-family: 'Space Mono', monospace;
  font-size: 14px;
  font-weight: 700;
  width: 28px;
  text-align: center;
  color: var(--text2);
}

.rank-1 { color: var(--yellow); }
.rank-2 { color: var(--text); }
.rank-3 { color: var(--orange); }

.lb-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--cyan));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.lb-info { flex: 1; }
.lb-name { font-weight: 600; font-size: 14px; }
.lb-score { font-size: 12px; color: var(--text2); font-family: 'Space Mono', monospace; }

/* TOAST */
.toast-container {
  position: fixed;
  top: 70px;
  right: 16px;
  left: 16px;
  z-index: 500;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}

.toast {
  background: var(--card2);
  border: 1px solid var(--border2);
  border-radius: 14px;
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: var(--shadow);
  transform: translateX(120%);
  transition: transform 0.3s ease;
  pointer-events: all;
}

.toast.show { transform: translateX(0); }
.toast-icon { font-size: 22px; flex-shrink: 0; }
.toast-text { flex: 1; }
.toast-title { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; }
.toast-desc { font-size: 12px; color: var(--text2); margin-top: 2px; }

/* INCOME PAGE */
.income-source-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.2s;
}

.income-source-card:hover { border-color: var(--green); }
.income-icon { font-size: 28px; }
.income-info { flex: 1; }
.income-source { font-weight: 600; font-size: 14px; }
.income-month { font-size: 12px; color: var(--text2); }
.income-amount { font-family: 'Space Mono', monospace; font-size: 18px; font-weight: 700; color: var(--green2); }

/* PROFILE */
.stat-grid-2x2 {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 16px;
}

.stat-mini {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius2);
  padding: 16px;
  text-align: center;
}

.stat-mini .val { font-family: 'Space Mono', monospace; font-size: 22px; font-weight: 700; margin-bottom: 4px; }
.stat-mini .key { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }

/* PERSONALITY CARD */
.personality-card {
  background: linear-gradient(135deg, rgba(6,182,212,0.1), rgba(124,58,237,0.1));
  border: 1px solid rgba(6,182,212,0.2);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
  text-align: center;
}

.personality-emoji { font-size: 48px; display: block; margin-bottom: 10px; }
.personality-type { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; margin-bottom: 6px; }
.personality-desc { font-size: 13px; color: var(--text2); line-height: 1.5; }

/* SAVINGS BUCKETS */
.bucket-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  margin-bottom: 10px;
}

.bucket-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.bucket-name-row { display: flex; align-items: center; gap: 10px; }
.bucket-emoji { font-size: 24px; }
.bucket-name { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; }
.bucket-amounts { font-size: 13px; color: var(--text2); font-family: 'Space Mono', monospace; }

/* LOADING */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
}

.loading-logo { font-size: 64px; animation: float 2s ease-in-out infinite; }
.loading-text { font-family: 'Syne', sans-serif; font-size: 16px; color: var(--text2); }

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* EMPTY STATE */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text2);
}

.empty-state .empty-icon { font-size: 48px; display: block; margin-bottom: 12px; opacity: 0.6; }
.empty-state p { font-size: 14px; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }

/* COINS ANIMATION */
@keyframes coinPop {
  0% { transform: scale(0) translateY(0); opacity: 1; }
  100% { transform: scale(1.5) translateY(-60px); opacity: 0; }
}

.coin-pop {
  position: fixed;
  font-size: 24px;
  pointer-events: none;
  z-index: 9000;
  animation: coinPop 1s ease forwards;
}

/* QUIZ GAME STYLES */
.quiz-container { width: 100%; max-width: 480px; }
.quiz-question { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 24px; line-height: 1.4; }
.quiz-options { display: flex; flex-direction: column; gap: 10px; }
.quiz-option {
  padding: 16px 20px;
  background: var(--card);
  border: 2px solid var(--border);
  border-radius: 14px;
  cursor: pointer;
  font-size: 15px;
  text-align: left;
  color: var(--text);
  transition: all 0.2s;
}
.quiz-option:hover { border-color: var(--accent); }
.quiz-option.correct { border-color: var(--green); background: rgba(16,185,129,0.1); }
.quiz-option.wrong { border-color: var(--red); background: rgba(239,68,68,0.1); }
.quiz-score-display { text-align: center; margin-bottom: 20px; }
.quiz-score-num { font-family: 'Syne', sans-serif; font-size: 48px; font-weight: 800; }

/* Reaction Game */
.reaction-target {
  width: 100px;
  height: 100px;
  background: linear-gradient(135deg, var(--accent), var(--cyan));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  cursor: pointer;
  transition: transform 0.1s;
  box-shadow: 0 0 40px rgba(124,58,237,0.5);
}

.reaction-target:active { transform: scale(0.9); }

/* add expense amount styling */
.amount-input-large {
  font-family: 'Space Mono', monospace;
  font-size: 36px;
  font-weight: 700;
  text-align: center;
  border: none;
  background: transparent;
  color: var(--text);
  width: 100%;
  outline: none;
  margin: 10px 0;
}

/* SETTINGS */
.settings-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 0;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
}

.settings-item:last-child { border-bottom: none; }
.settings-label { font-size: 15px; font-weight: 500; }
.settings-value { font-size: 14px; color: var(--text2); }

/* Budget input */
.budget-set-card {
  background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(6,182,212,0.1));
  border: 1px solid rgba(16,185,129,0.2);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
  text-align: center;
}

/* Pill tabs */
.pill-tabs {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding-bottom: 4px;
  margin-bottom: 16px;
}

.pill-tab {
  padding: 8px 18px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
  font-family: 'Syne', sans-serif;
}

.pill-tab.active {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-color: transparent;
  color: white;
}

@media (max-width: 380px) {
  .balance-amount { font-size: 36px; }
  .quick-actions { grid-template-columns: repeat(4, 1fr); }
  .badges-grid { grid-template-columns: repeat(3, 1fr); }
}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-overlay" id="loading-overlay">
  <div class="loading-logo">üí∞</div>
  <div class="loading-text">Loading PaisaPlay...</div>
  <div class="spinner"></div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toast-container"></div>

<!-- AUTH SCREEN -->
<div id="auth-screen" style="display:none">
  <div class="auth-container">
    <div class="auth-logo">
      <span class="logo-icon">üí∞</span>
      <h1>PaisaPlay</h1>
      <p>Your AI-Powered Student Money OS</p>
    </div>
    <div class="auth-card">
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
        <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
      </div>
      <div id="auth-error" class="auth-error"></div>
      
      <!-- LOGIN -->
      <div id="login-form">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" placeholder="you@college.edu">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button class="btn-primary" onclick="handleLogin()">Login ‚Üí</button>
      </div>
      
      <!-- SIGNUP -->
      <div id="signup-form" style="display:none">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="signup-name" placeholder="Your name">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="signup-email" placeholder="you@college.edu">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="signup-password" placeholder="Min 6 characters">
        </div>
        <div class="form-group">
          <label>Monthly Budget (‚Çπ)</label>
          <input type="number" id="signup-budget" placeholder="e.g. 10000">
        </div>
        <button class="btn-primary" onclick="handleSignup()">Start Saving üöÄ</button>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <!-- TOP NAV -->
  <nav class="topnav">
    <div class="nav-logo">üí∞ PaisaPlay</div>
    <div class="nav-right">
      <div class="xp-pill">
        <div class="level-badge" id="nav-level">1</div>
        <span id="nav-points">0 XP</span>
      </div>
      <div class="streak-pill">üî• <span id="nav-streak">0</span></div>
      <button class="avatar-btn" onclick="showPage('profile')">üë§</button>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="main-content">

    <!-- HOME PAGE -->
    <div id="page-home" class="page active">
      <div class="balance-hero" id="balance-hero">
        <div class="balance-label">Available Balance</div>
        <div class="balance-amount"><span class="currency">‚Çπ</span><span id="balance-amount">0</span></div>
        <div class="balance-row">
          <div class="balance-stat">
            <div class="stat-val" style="color:var(--green2)">‚Çπ<span id="total-income">0</span></div>
            <div class="stat-lbl">Income</div>
          </div>
          <div class="balance-stat">
            <div class="stat-val" style="color:var(--red2)">‚Çπ<span id="total-expenses">0</span></div>
            <div class="stat-lbl">Spent</div>
          </div>
          <div class="balance-stat">
            <div class="stat-val" style="color:var(--cyan)">‚Çπ<span id="savings-amount">0</span></div>
            <div class="stat-lbl">Saved</div>
          </div>
        </div>
      </div>

      <!-- SURVIVAL SYSTEM -->
      <div class="survival-card">
        <div class="survival-header">
          <div>
            <div class="section-title">Survival Budget</div>
            <div style="font-size:13px;color:var(--text2);margin-top:3px">Month-end predictor</div>
          </div>
          <div class="risk-badge risk-safe" id="risk-badge">SAFE</div>
        </div>
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" id="budget-progress" style="width:0%;background:linear-gradient(90deg,var(--green),var(--cyan))"></div>
        </div>
        <div class="survival-stats">
          <div class="surv-stat">
            <div class="val" id="days-left">--</div>
            <div class="lbl">Days Left</div>
          </div>
          <div class="surv-stat">
            <div class="val" id="daily-safe">‚Çπ--</div>
            <div class="lbl">Safe/Day</div>
          </div>
          <div class="surv-stat">
            <div class="val" id="zero-date">--</div>
            <div class="lbl">Zero Date</div>
          </div>
        </div>
      </div>

      <!-- QUICK ACTIONS -->
      <div class="quick-actions">
        <button class="qa-btn" onclick="openModal('expense-modal')">
          <span class="qa-icon">‚ûï</span>
          <span class="qa-label">Add Expense</span>
        </button>
        <button class="qa-btn" onclick="openModal('income-modal')">
          <span class="qa-icon">üíµ</span>
          <span class="qa-label">Add Income</span>
        </button>
        <button class="qa-btn" onclick="showPage('chat')">
          <span class="qa-icon">ü§ñ</span>
          <span class="qa-label">AI Coach</span>
        </button>
        <button class="qa-btn" onclick="showPage('games')">
          <span class="qa-icon">üéÆ</span>
          <span class="qa-label">Fun Zone</span>
        </button>
      </div>

      <!-- HEALTH SCORE -->
      <div class="health-score-container">
        <div class="score-ring">
          <svg width="90" height="90" viewBox="0 0 90 90">
            <circle cx="45" cy="45" r="38" fill="none" stroke="var(--border)" stroke-width="8"/>
            <circle cx="45" cy="45" r="38" fill="none" stroke="url(#scoreGrad)" stroke-width="8"
              stroke-linecap="round" stroke-dasharray="239" id="score-circle" stroke-dashoffset="239"/>
            <defs>
              <linearGradient id="scoreGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#10b981"/>
                <stop offset="100%" stop-color="#06b6d4"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="score-text">
            <div class="score-number" id="health-score-num">--</div>
            <div class="score-label">SCORE</div>
          </div>
        </div>
        <div class="health-info">
          <h3>Money Health</h3>
          <p id="health-desc">Start tracking expenses to get your financial health score.</p>
        </div>
      </div>

      <!-- RECENT EXPENSES -->
      <div class="section-header">
        <div class="section-title">Recent Expenses</div>
        <button class="section-link" onclick="showPage('analytics')">See All</button>
      </div>
      <div class="card" style="padding:0 20px" id="recent-expenses-list">
        <div class="empty-state">
          <span class="empty-icon">üßæ</span>
          <p>No expenses yet. Add your first one!</p>
        </div>
      </div>
    </div>

    <!-- ANALYTICS PAGE -->
    <div id="page-analytics" class="page">
      <h2 style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;margin-bottom:20px">Analytics üìä</h2>
      
      <div class="pill-tabs">
        <button class="pill-tab active" onclick="setAnalyticsPeriod('month', this)">This Month</button>
        <button class="pill-tab" onclick="setAnalyticsPeriod('week', this)">This Week</button>
        <button class="pill-tab" onclick="setAnalyticsPeriod('all', this)">All Time</button>
      </div>

      <div class="chart-card">
        <h3>Spending by Category</h3>
        <canvas id="categoryChart" height="200"></canvas>
      </div>

      <div class="chart-card">
        <h3>Daily Spending Trend</h3>
        <canvas id="trendChart" height="180"></canvas>
      </div>

      <div class="chart-card">
        <h3>Expense Heatmap</h3>
        <div style="font-size:12px;color:var(--text2);margin-bottom:10px">Last 30 days activity</div>
        <div class="heatmap-grid" id="heatmap-grid"></div>
      </div>

      <div class="chart-card">
        <h3>All Expenses</h3>
        <div id="all-expenses-list">
          <div class="empty-state"><span class="empty-icon">üßæ</span><p>No expenses yet.</p></div>
        </div>
      </div>
    </div>

    <!-- GAMIFICATION PAGE -->
    <div id="page-gamify" class="page">
      <h2 style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;margin-bottom:20px">Level Up üèÜ</h2>
      
      <div class="level-card" id="level-card">
        <span class="level-emoji" id="level-emoji">üå±</span>
        <div class="level-name" id="level-name">Beginner Saver</div>
        <div class="level-sub" id="level-sub">Keep tracking to level up!</div>
        <div class="xp-bar-container">
          <div class="xp-bar-label">
            <span id="xp-current">0 XP</span>
            <span id="xp-next">500 XP to next level</span>
          </div>
          <div class="xp-bar-bg">
            <div class="xp-bar-fill" id="xp-bar" style="width:0%"></div>
          </div>
        </div>
      </div>

      <div class="streak-display">
        <div>üî•</div>
        <div class="streak-num" id="streak-num">0</div>
        <div class="streak-info">
          <h3>Day Streak</h3>
          <p>Best: <span id="best-streak">0</span> days</p>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title">Achievements</div>
        <div class="section-link" style="font-size:12px;color:var(--text2)" id="badges-count">0/12 earned</div>
      </div>
      <div class="badges-grid" id="badges-grid"></div>

      <div class="section-header">
        <div class="section-title">Active Challenges</div>
        <button class="section-link" onclick="openModal('challenge-modal')">+ New</button>
      </div>
      <div id="challenges-list">
        <div class="empty-state"><span class="empty-icon">üéØ</span><p>No active challenges. Start one!</p></div>
      </div>

      <div class="section-header" style="margin-top:8px">
        <div class="section-title">Leaderboard</div>
      </div>
      <div class="card" style="padding:0 20px" id="leaderboard-list"></div>
    </div>

    <!-- CHAT PAGE -->
    <div id="page-chat" class="page">
      <h2 style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;margin-bottom:16px">AI Coach ü§ñ</h2>
      
      <div class="chat-mode-tabs">
        <button class="chat-mode-btn active" onclick="setChatMode('finance_coach', this)">üíº Finance Coach</button>
        <button class="chat-mode-btn" onclick="setChatMode('expense_assistant', this)">üí¨ Expense Q&A</button>
        <button class="chat-mode-btn" onclick="setChatMode('motivation', this)">üî• Motivation</button>
      </div>

      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="chat-bubble assistant">
            üëã Hi! I'm your AI finance coach. Ask me about budgeting, saving strategies, or your spending habits. I have access to your expense data to give personalized advice!
          </div>
        </div>
        <div class="chat-input-row">
          <textarea class="chat-input" id="chat-input" placeholder="Ask your finance coach..." rows="1" 
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"
            oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
          <button class="chat-send" onclick="sendChat()">‚û§</button>
        </div>
      </div>
    </div>

    <!-- GAMES PAGE -->
    <div id="page-games" class="page">
      <h2 style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;margin-bottom:20px">Fun Zone üéÆ</h2>
      
      <div class="games-grid">
        <div class="game-card" style="background:linear-gradient(135deg,#1a1025,#0d1520)">
          <div class="game-card-header">
            <div class="game-emoji">ü™ô</div>
            <div>
              <div class="game-title">Money Catch</div>
              <div class="game-desc">Catch coins, avoid expenses!</div>
            </div>
          </div>
          <div class="game-meta">
            <div class="high-score">Best: <span id="hs-money-catch">0</span></div>
            <button class="play-btn" onclick="startGame('money_catch')">Play ‚ñ∂</button>
          </div>
        </div>
        
        <div class="game-card" style="background:linear-gradient(135deg,#0d1a15,#0a1a20)">
          <div class="game-card-header">
            <div class="game-emoji">üß†</div>
            <div>
              <div class="game-title">Budget Quiz</div>
              <div class="game-desc">Test your financial IQ!</div>
            </div>
          </div>
          <div class="game-meta">
            <div class="high-score">Best: <span id="hs-budget-quiz">0</span>/10</div>
            <button class="play-btn" onclick="startGame('budget_quiz')">Play ‚ñ∂</button>
          </div>
        </div>

        <div class="game-card" style="background:linear-gradient(135deg,#1a0a15,#1a150a)">
          <div class="game-card-header">
            <div class="game-emoji">‚ö°</div>
            <div>
              <div class="game-title">Reaction Speed</div>
              <div class="game-desc">Tap money icons fast!</div>
            </div>
          </div>
          <div class="game-meta">
            <div class="high-score">Best: <span id="hs-reaction">0</span>ms</div>
            <button class="play-btn" onclick="startGame('reaction_speed')">Play ‚ñ∂</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PROFILE PAGE -->
    <div id="page-profile" class="page">
      <h2 style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;margin-bottom:20px">Profile üë§</h2>
      
      <div class="personality-card">
        <span class="personality-emoji" id="personality-emoji">ü§î</span>
        <div class="personality-type" id="personality-type">Analyzing...</div>
        <div class="personality-desc" id="personality-desc">Track more expenses to get your money personality.</div>
      </div>

      <div class="stat-grid-2x2">
        <div class="stat-mini">
          <div class="val" style="color:var(--accent2)" id="profile-points">0</div>
          <div class="key">Total XP</div>
        </div>
        <div class="stat-mini">
          <div class="val" style="color:var(--yellow)" id="profile-coins">0</div>
          <div class="key">Coins ü™ô</div>
        </div>
        <div class="stat-mini">
          <div class="val" style="color:var(--orange)" id="profile-streak">0</div>
          <div class="key">Day Streak</div>
        </div>
        <div class="stat-mini">
          <div class="val" style="color:var(--green2)" id="profile-badges">0</div>
          <div class="key">Badges</div>
        </div>
      </div>

      <!-- BUDGET SETTINGS -->
      <div class="budget-set-card">
        <div style="font-size:13px;color:var(--text2);margin-bottom:8px">Monthly Budget</div>
        <div style="font-family:'Syne',sans-serif;font-size:32px;font-weight:800;margin-bottom:12px">‚Çπ<span id="profile-budget">0</span></div>
        <button class="btn-primary" style="width:auto;padding:10px 24px;font-size:14px" onclick="openModal('budget-modal')">Update Budget</button>
      </div>

      <!-- SAVINGS BUCKETS -->
      <div class="section-header">
        <div class="section-title">Savings Buckets</div>
        <button class="section-link" onclick="openModal('bucket-modal')">+ Add</button>
      </div>
      <div id="buckets-list">
        <div class="empty-state"><span class="empty-icon">ü™£</span><p>Create savings goals!</p></div>
      </div>

      <!-- BILL REMINDERS -->
      <div class="section-header" style="margin-top:8px">
        <div class="section-title">Bill Reminders</div>
        <button class="section-link" onclick="openModal('reminder-modal')">+ Add</button>
      </div>
      <div id="reminders-list">
        <div class="empty-state"><span class="empty-icon">‚è∞</span><p>No bill reminders set.</p></div>
      </div>

      <!-- INCOME TRACKING -->
      <div class="section-header" style="margin-top:8px">
        <div class="section-title">Income Sources</div>
        <button class="section-link" onclick="openModal('income-modal')">+ Add</button>
      </div>
      <div id="income-list-profile">
        <div class="empty-state"><span class="empty-icon">üíµ</span><p>Add your income sources.</p></div>
      </div>

      <div style="margin-top:20px">
        <button class="btn-primary" style="background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.3);color:var(--red2)" onclick="handleLogout()">Logout</button>
      </div>
    </div>

  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottomnav">
    <button class="nav-item active" onclick="showPage('home')">
      <span class="nav-icon">üè†</span>
      <span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="showPage('analytics')">
      <span class="nav-icon">üìä</span>
      <span class="nav-label">Analytics</span>
    </button>
    <button class="nav-item" onclick="showPage('gamify')">
      <span class="nav-icon">üèÜ</span>
      <span class="nav-label">Level Up</span>
    </button>
    <button class="nav-item" onclick="showPage('chat')">
      <span class="nav-icon">ü§ñ</span>
      <span class="nav-label">AI Coach</span>
    </button>
    <button class="nav-item" onclick="showPage('games')">
      <span class="nav-icon">üéÆ</span>
      <span class="nav-label">Games</span>
    </button>
  </nav>
</div>

<!-- MODALS -->

<!-- ADD EXPENSE MODAL -->
<div class="modal-overlay" id="expense-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Add Expense üí∏</div>
    
    <div style="text-align:center;margin-bottom:16px">
      <div style="font-size:13px;color:var(--text2);margin-bottom:4px">Amount (‚Çπ)</div>
      <input type="number" class="amount-input-large" id="exp-amount" placeholder="0">
    </div>

    <div class="form-group">
      <label>Description</label>
      <input type="text" id="exp-desc" placeholder="What did you spend on?" oninput="autoCateg()">
    </div>

    <div style="margin-bottom:16px">
      <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px">Category</label>
      <div class="category-grid">
        <button class="cat-option" data-cat="food" onclick="selectCat(this)"><span class="cat-emoji">üçï</span><span class="cat-name">Food</span></button>
        <button class="cat-option" data-cat="rent" onclick="selectCat(this)"><span class="cat-emoji">üè†</span><span class="cat-name">Rent</span></button>
        <button class="cat-option" data-cat="travel" onclick="selectCat(this)"><span class="cat-emoji">üöå</span><span class="cat-name">Travel</span></button>
        <button class="cat-option" data-cat="education" onclick="selectCat(this)"><span class="cat-emoji">üìö</span><span class="cat-name">Education</span></button>
        <button class="cat-option" data-cat="shopping" onclick="selectCat(this)"><span class="cat-emoji">üõçÔ∏è</span><span class="cat-name">Shopping</span></button>
        <button class="cat-option" data-cat="entertainment" onclick="selectCat(this)"><span class="cat-emoji">üé¨</span><span class="cat-name">Fun</span></button>
        <button class="cat-option" data-cat="health" onclick="selectCat(this)"><span class="cat-emoji">üíä</span><span class="cat-name">Health</span></button>
        <button class="cat-option" data-cat="other" onclick="selectCat(this)"><span class="cat-emoji">üì¶</span><span class="cat-name">Other</span></button>
      </div>
    </div>

    <div style="margin-bottom:16px">
      <label style="display:block;font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px">Mood while spending</label>
      <div class="mood-row">
        <button class="mood-btn" data-mood="happy" onclick="selectMood(this)"><span>üòä</span><span>Happy</span></button>
        <button class="mood-btn" data-mood="neutral" onclick="selectMood(this)"><span>üòê</span><span>Meh</span></button>
        <button class="mood-btn" data-mood="stressed" onclick="selectMood(this)"><span>üò∞</span><span>Stressed</span></button>
        <button class="mood-btn" data-mood="regret" onclick="selectMood(this)"><span>üò¨</span><span>Regret</span></button>
        <button class="mood-btn" data-mood="necessary" onclick="selectMood(this)"><span>‚úÖ</span><span>Needed</span></button>
      </div>
    </div>

    <button class="btn-primary" onclick="addExpense()">Add Expense üéØ</button>
  </div>
</div>

<!-- ADD INCOME MODAL -->
<div class="modal-overlay" id="income-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Add Income üíµ</div>
    
    <div class="form-group">
      <label>Source</label>
      <select id="inc-source">
        <option value="parent_allowance">üë®‚Äçüë©‚Äçüëß Parent Allowance</option>
        <option value="internship">üíº Internship Salary</option>
        <option value="part_time">‚è∞ Part-Time Job</option>
        <option value="scholarship">üéì Scholarship</option>
        <option value="other">üì¶ Other</option>
      </select>
    </div>
    <div class="form-group">
      <label>Amount (‚Çπ)</label>
      <input type="number" id="inc-amount" placeholder="Enter amount">
    </div>
    <div class="form-group">
      <label>Description (optional)</label>
      <input type="text" id="inc-desc" placeholder="Notes">
    </div>
    <button class="btn-primary" onclick="addIncome()">Add Income ‚úÖ</button>
  </div>
</div>

<!-- BUDGET MODAL -->
<div class="modal-overlay" id="budget-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Set Monthly Budget</div>
    <div class="form-group">
      <label>Monthly Budget (‚Çπ)</label>
      <input type="number" id="budget-input" placeholder="e.g. 10000">
    </div>
    <button class="btn-primary" onclick="updateBudget()">Update Budget ‚úÖ</button>
  </div>
</div>

<!-- CHALLENGE MODAL -->
<div class="modal-overlay" id="challenge-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">New Challenge üéØ</div>
    
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px">
      <button class="cat-option" onclick="selectChallenge(this,'Spend Under ‚Çπ200/day','Keep daily spending below ‚Çπ200',null,200,7)" style="padding:16px">
        <span style="font-size:28px">üí∏</span><span style="font-size:12px;color:var(--text2);margin-top:6px">Under ‚Çπ200/day</span>
      </button>
      <button class="cat-option" onclick="selectChallenge(this,'No Food Delivery','Order from restaurant instead of delivery',null,null,5)" style="padding:16px">
        <span style="font-size:28px">üö´</span><span style="font-size:12px;color:var(--text2);margin-top:6px">No Delivery 5 days</span>
      </button>
      <button class="cat-option" onclick="selectChallenge(this,'Save ‚Çπ500 This Week','Spend less, save more!',500,null,7)" style="padding:16px">
        <span style="font-size:28px">üè¶</span><span style="font-size:12px;color:var(--text2);margin-top:6px">Save ‚Çπ500</span>
      </button>
      <button class="cat-option" onclick="selectChallenge(this,'Zero Entertainment','No fun spending for 3 days',null,0,3)" style="padding:16px">
        <span style="font-size:28px">üéØ</span><span style="font-size:12px;color:var(--text2);margin-top:6px">Zero Fun Spend</span>
      </button>
    </div>

    <div class="form-group">
      <label>Custom Challenge Name</label>
      <input type="text" id="chal-title" placeholder="e.g. Coffee-free week">
    </div>
    <div class="form-group">
      <label>Duration (days)</label>
      <input type="number" id="chal-days" placeholder="7" value="7">
    </div>
    <button class="btn-primary" onclick="addChallenge()">Start Challenge üöÄ</button>
  </div>
</div>

<!-- SAVINGS BUCKET MODAL -->
<div class="modal-overlay" id="bucket-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">New Savings Goal ü™£</div>
    <div class="form-group">
      <label>Goal Name</label>
      <input type="text" id="bucket-name" placeholder="e.g. New Laptop, Trip to Goa">
    </div>
    <div class="form-group">
      <label>Target Amount (‚Çπ)</label>
      <input type="number" id="bucket-target" placeholder="e.g. 20000">
    </div>
    <div class="form-group">
      <label>Icon</label>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="mood-btn" onclick="selectBucketIcon(this,'üéØ')"><span>üéØ</span></button>
        <button class="mood-btn" onclick="selectBucketIcon(this,'üíª')"><span>üíª</span></button>
        <button class="mood-btn" onclick="selectBucketIcon(this,'‚úàÔ∏è')"><span>‚úàÔ∏è</span></button>
        <button class="mood-btn" onclick="selectBucketIcon(this,'üì±')"><span>üì±</span></button>
        <button class="mood-btn" onclick="selectBucketIcon(this,'üé∏')"><span>üé∏</span></button>
        <button class="mood-btn" onclick="selectBucketIcon(this,'üöó')"><span>üöó</span></button>
      </div>
    </div>
    <button class="btn-primary" onclick="addBucket()">Create Goal ‚úÖ</button>
  </div>
</div>

<!-- BILL REMINDER MODAL -->
<div class="modal-overlay" id="reminder-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Add Bill Reminder ‚è∞</div>
    <div class="form-group">
      <label>Bill Name</label>
      <input type="text" id="rem-title" placeholder="e.g. Rent, Netflix, Gym">
    </div>
    <div class="form-group">
      <label>Amount (‚Çπ)</label>
      <input type="number" id="rem-amount" placeholder="Monthly amount">
    </div>
    <div class="form-group">
      <label>Due Date</label>
      <input type="date" id="rem-date">
    </div>
    <button class="btn-primary" onclick="addReminder()">Set Reminder ‚úÖ</button>
  </div>
</div>

<!-- GAME OVERLAY -->
<div class="game-overlay" id="game-overlay">
  <div class="game-header">
    <h2 id="game-title">Game</h2>
    <div style="display:flex;align-items:center;gap:12px">
      <div class="mono" style="font-size:18px;color:var(--yellow)">Score: <span id="current-score">0</span></div>
      <button class="close-game" onclick="closeGame()">‚úï</button>
    </div>
  </div>
  <div id="game-canvas-container"></div>
</div>

<script>
// ===== SUPABASE INIT =====
const SUPABASE_URL = 'https://ystsavyntfbpmqyboetr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdHNhdnludGZicG1xeWJvZXRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MTU1MDcsImV4cCI6MjA4NzA5MTUwN30.4519Tj8_zOWhOVn2lm-OqVVpavXBxo-7OlRRyF02Pj8';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ===== STATE =====
let currentUser = null;
let userProfile = null;
let userGamification = null;
let expenses = [];
let incomes = [];
let achievements = [];
let challenges = [];
let buckets = [];
let reminders = [];
let selectedCategory = 'other';
let selectedMood = 'neutral';
let selectedBucketIcon = 'üéØ';
let chatMode = 'finance_coach';
let chatHistory = [];
let currentGame = null;
let gameActive = false;
let analyticsPeriod = 'month';
let categoryChartInstance = null;
let trendChartInstance = null;

// Category config
const catConfig = {
  food: { icon: 'üçï', color: '#f59e0b' },
  rent: { icon: 'üè†', color: '#3b82f6' },
  travel: { icon: 'üöå', color: '#10b981' },
  education: { icon: 'üìö', color: '#8b5cf6' },
  shopping: { icon: 'üõçÔ∏è', color: '#ec4899' },
  entertainment: { icon: 'üé¨', color: '#f97316' },
  health: { icon: 'üíä', color: '#06b6d4' },
  subscription: { icon: 'üì±', color: '#ef4444' },
  other: { icon: 'üì¶', color: '#64748b' }
};

const levels = [
  { min: 0, name: 'Beginner Saver', emoji: 'üå±', color: '#64748b' },
  { min: 500, name: 'Smart Spender', emoji: 'üí°', color: '#06b6d4' },
  { min: 1500, name: 'Budget Warrior', emoji: '‚öîÔ∏è', color: '#3b82f6' },
  { min: 3500, name: 'Money Master', emoji: 'üèÜ', color: '#a855f7' },
  { min: 7500, name: 'Financial Pro', emoji: 'üíé', color: '#f59e0b' }
];

const allBadges = [
  { key: 'first_expense', name: 'First Step', icon: 'üéØ', desc: 'Added first expense' },
  { key: 'streak_3', name: '3-Day Streak', icon: 'üî•', desc: '3 consecutive days logged' },
  { key: 'streak_7', name: 'Week Warrior', icon: 'üóìÔ∏è', desc: '7 day streak' },
  { key: 'saved_1000', name: 'Saver ‚Çπ1k', icon: 'üí∞', desc: 'Saved ‚Çπ1000' },
  { key: 'saved_5000', name: 'Big Saver', icon: 'üè¶', desc: 'Saved ‚Çπ5000' },
  { key: 'budget_week', name: 'Budget Week', icon: '‚úÖ', desc: 'Under budget for a week' },
  { key: 'five_expenses', name: 'Tracker', icon: 'üìã', desc: '5 expenses logged' },
  { key: 'ten_expenses', name: 'Pro Tracker', icon: 'üìä', desc: '10 expenses logged' },
  { key: 'challenge_complete', name: 'Challenger', icon: '‚ö°', desc: 'Completed a challenge' },
  { key: 'quiz_perfect', name: 'Quiz Ace', icon: 'üß†', desc: 'Perfect score in quiz' },
  { key: 'game_player', name: 'Gamer', icon: 'üéÆ', desc: 'Played a game' },
  { key: 'income_added', name: 'Income Pro', icon: 'üíµ', desc: 'Added income source' }
];

// ===== INIT =====
async function init() {
  const { data: { session } } = await sb.auth.getSession();
  document.getElementById('loading-overlay').style.display = 'none';
  
  if (session?.user) {
    currentUser = session.user;
    await loadUserData();
    showApp();
  } else {
    document.getElementById('auth-screen').style.display = 'flex';
  }

  sb.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN') {
      currentUser = session.user;
      await loadUserData();
      showApp();
    } else if (event === 'SIGNED_OUT') {
      document.getElementById('app').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'flex';
    }
  });
}

function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  updateUI();
  checkDailyStreak();
}

async function loadUserData() {
  // Load profile
  let { data: profile } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  if (!profile) {
    await sb.from('profiles').insert({ id: currentUser.id, full_name: currentUser.user_metadata?.full_name || 'Student' });
    profile = { id: currentUser.id, full_name: 'Student', monthly_budget: 0 };
  }
  userProfile = profile;

  // Load gamification
  let { data: gamif } = await sb.from('gamification').select('*').eq('user_id', currentUser.id).single();
  if (!gamif) {
    await sb.from('gamification').insert({ user_id: currentUser.id });
    gamif = { user_id: currentUser.id, total_points: 0, coins: 0, current_level: 1, current_streak: 0 };
  }
  userGamification = gamif;

  // Load all data
  const now = new Date();
  const monthYear = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  
  const [expRes, incRes, achRes, chalRes, bucRes, remRes] = await Promise.all([
    sb.from('expenses').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }),
    sb.from('incomes').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }),
    sb.from('achievements').select('*').eq('user_id', currentUser.id),
    sb.from('challenges').select('*').eq('user_id', currentUser.id).eq('status', 'active'),
    sb.from('savings_buckets').select('*').eq('user_id', currentUser.id),
    sb.from('bill_reminders').select('*').eq('user_id', currentUser.id).eq('is_paid', false),
  ]);

  expenses = expRes.data || [];
  incomes = incRes.data || [];
  achievements = achRes.data || [];
  challenges = chalRes.data || [];
  buckets = bucRes.data || [];
  reminders = remRes.data || [];

  // Load game scores
  const { data: scores } = await sb.from('game_scores').select('*').eq('user_id', currentUser.id);
  if (scores) {
    const byCatch = scores.filter(s => s.game_type === 'money_catch');
    const byQuiz = scores.filter(s => s.game_type === 'budget_quiz');
    const byReact = scores.filter(s => s.game_type === 'reaction_speed');
    
    document.getElementById('hs-money-catch').textContent = byCatch.length ? Math.max(...byCatch.map(s=>s.score)) : 0;
    document.getElementById('hs-budget-quiz').textContent = byQuiz.length ? Math.max(...byQuiz.map(s=>s.score)) : 0;
    document.getElementById('hs-reaction').textContent = byReact.length ? Math.min(...byReact.map(s=>s.score)) : 0;
  }

  // Load chat history
  const { data: chatData } = await sb.from('chat_history').select('*').eq('user_id', currentUser.id).order('created_at').limit(20);
  if (chatData && chatData.length > 0) {
    chatHistory = chatData.map(m => ({ role: m.role, content: m.content }));
  }
}

function updateUI() {
  updateBalanceDisplay();
  updateSurvivalSystem();
  updateGamificationUI();
  renderRecentExpenses();
  renderAnalytics();
  renderBadges();
  renderChallenges();
  renderBuckets();
  renderReminders();
  renderIncomeList();
  renderLeaderboard();
  updatePersonality();
  updateNavStats();
}

// ===== BALANCE =====
function updateBalanceDisplay() {
  const now = new Date();
  const monthYear = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  
  const monthIncomes = incomes.filter(i => i.month_year === monthYear);
  const totalIncome = monthIncomes.reduce((s,i) => s + parseFloat(i.amount || 0), 0);
  
  const monthExp = expenses.filter(e => {
    const d = new Date(e.expense_date || e.created_at);
    return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
  });
  const totalSpent = monthExp.reduce((s,e) => s + parseFloat(e.amount || 0), 0);
  const budget = parseFloat(userProfile?.monthly_budget || 0);
  const balance = (budget + totalIncome) - totalSpent;
  const savings = Math.max(0, balance);

  document.getElementById('balance-amount').textContent = Math.round(balance).toLocaleString('en-IN');
  document.getElementById('total-income').textContent = Math.round(totalIncome + budget).toLocaleString('en-IN');
  document.getElementById('total-expenses').textContent = Math.round(totalSpent).toLocaleString('en-IN');
  document.getElementById('savings-amount').textContent = Math.round(savings).toLocaleString('en-IN');
  document.getElementById('profile-budget').textContent = budget.toLocaleString('en-IN');

  // Health score calculation
  const score = calculateHealthScore(balance, totalSpent, budget);
  updateHealthScore(score);
}

function calculateHealthScore(balance, spent, budget) {
  if (!budget) return 50;
  const spendRatio = spent / (budget || 1);
  let score = Math.max(0, Math.min(100, Math.round((1 - spendRatio) * 80 + (userGamification?.current_streak || 0) * 2)));
  return Math.min(100, score);
}

function updateHealthScore(score) {
  document.getElementById('health-score-num').textContent = score;
  const circumference = 239;
  const offset = circumference - (score / 100) * circumference;
  document.getElementById('score-circle').style.strokeDashoffset = offset;
  
  const desc = score >= 80 ? 'üåü Excellent financial discipline! Keep it up!'
    : score >= 60 ? 'üëç Good money habits. Room to improve!'
    : score >= 40 ? '‚ö†Ô∏è Watch your spending this month.'
    : 'üö® Budget at risk! Cut non-essential spending.';
  document.getElementById('health-desc').textContent = desc;

  if (userGamification) {
    sb.from('gamification').update({ money_health_score: score }).eq('user_id', currentUser.id);
  }
}

// ===== SURVIVAL SYSTEM =====
function updateSurvivalSystem() {
  const now = new Date();
  const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
  const daysLeft = daysInMonth - now.getDate();
  
  const budget = parseFloat(userProfile?.monthly_budget || 0);
  const monthExp = expenses.filter(e => {
    const d = new Date(e.expense_date || e.created_at);
    return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
  });
  const totalSpent = monthExp.reduce((s,e) => s + parseFloat(e.amount || 0), 0);
  const balance = budget - totalSpent;
  const safeDaily = daysLeft > 0 ? Math.round(balance / daysLeft) : 0;
  
  // When will money run out?
  let zeroDate = 'Safe üü¢';
  if (safeDaily <= 0 || balance <= 0) {
    zeroDate = 'Now! üö®';
  } else if (safeDaily < 100) {
    const daysToZero = Math.floor(balance / (totalSpent / (now.getDate() || 1)));
    const zeroDay = new Date(now);
    zeroDay.setDate(zeroDay.getDate() + daysToZero);
    zeroDate = zeroDay.getDate() + '/' + (zeroDay.getMonth()+1);
  }

  document.getElementById('days-left').textContent = daysLeft;
  document.getElementById('daily-safe').textContent = '‚Çπ' + Math.max(0, safeDaily).toLocaleString('en-IN');
  document.getElementById('zero-date').textContent = zeroDate;

  const spendPercent = budget > 0 ? Math.min(100, (totalSpent / budget) * 100) : 0;
  document.getElementById('budget-progress').style.width = spendPercent + '%';
  
  const badge = document.getElementById('risk-badge');
  if (spendPercent > 90) {
    badge.className = 'risk-badge risk-critical';
    badge.textContent = 'CRITICAL';
    document.getElementById('budget-progress').style.background = 'linear-gradient(90deg,var(--red),var(--red2))';
  } else if (spendPercent > 70) {
    badge.className = 'risk-badge risk-warning';
    badge.textContent = 'WARNING';
    document.getElementById('budget-progress').style.background = 'linear-gradient(90deg,var(--yellow),var(--orange))';
  } else {
    badge.className = 'risk-badge risk-safe';
    badge.textContent = 'SAFE';
    document.getElementById('budget-progress').style.background = 'linear-gradient(90deg,var(--green),var(--cyan))';
  }
}

// ===== NAV STATS =====
function updateNavStats() {
  const g = userGamification;
  if (!g) return;
  document.getElementById('nav-level').textContent = g.current_level || 1;
  document.getElementById('nav-points').textContent = (g.total_points || 0) + ' XP';
  document.getElementById('nav-streak').textContent = g.current_streak || 0;
  document.getElementById('profile-points').textContent = (g.total_points || 0).toLocaleString('en-IN');
  document.getElementById('profile-coins').textContent = (g.coins || 0).toLocaleString('en-IN');
  document.getElementById('profile-streak').textContent = g.current_streak || 0;
  document.getElementById('profile-badges').textContent = achievements.length;
}

// ===== GAMIFICATION UI =====
function updateGamificationUI() {
  const g = userGamification;
  if (!g) return;
  
  const pts = g.total_points || 0;
  let lvl = 0;
  for (let i = levels.length-1; i >= 0; i--) {
    if (pts >= levels[i].min) { lvl = i; break; }
  }
  
  const curLevel = levels[lvl];
  const nextLevel = levels[lvl+1];
  const progress = nextLevel ? ((pts - curLevel.min) / (nextLevel.min - curLevel.min)) * 100 : 100;
  
  document.getElementById('level-emoji').textContent = curLevel.emoji;
  document.getElementById('level-name').textContent = curLevel.name;
  document.getElementById('level-sub').textContent = `Level ${lvl+1} ‚Äî ${pts} XP total`;
  document.getElementById('xp-current').textContent = pts + ' XP';
  document.getElementById('xp-next').textContent = nextLevel ? `${nextLevel.min - pts} XP to ${nextLevel.name}` : 'Max Level! üéâ';
  document.getElementById('xp-bar').style.width = Math.min(100, progress) + '%';
  document.getElementById('streak-num').textContent = g.current_streak || 0;
  document.getElementById('best-streak').textContent = g.longest_streak || 0;

  // Update nav
  document.getElementById('nav-level').textContent = lvl + 1;
}

// ===== BADGES =====
function renderBadges() {
  const earnedKeys = achievements.map(a => a.badge_key);
  document.getElementById('badges-count').textContent = `${earnedKeys.length}/${allBadges.length} earned`;
  
  const html = allBadges.map(b => `
    <div class="badge-item ${earnedKeys.includes(b.key) ? 'earned' : 'locked'}" title="${b.desc}">
      <span class="badge-emoji">${b.icon}</span>
      <div class="badge-name">${b.name}</div>
    </div>
  `).join('');
  document.getElementById('badges-grid').innerHTML = html;
}

// ===== CHALLENGES =====
function renderChallenges() {
  if (!challenges.length) {
    document.getElementById('challenges-list').innerHTML = '<div class="empty-state"><span class="empty-icon">üéØ</span><p>No active challenges. Start one!</p></div>';
    return;
  }

  const html = challenges.map(c => {
    const start = new Date(c.start_date);
    const end = new Date(c.end_date);
    const now = new Date();
    const daysLeft = Math.max(0, Math.ceil((end - now) / (1000*60*60*24)));
    const progress = c.progress || 0;
    
    return `
    <div class="challenge-card">
      <div class="challenge-header">
        <div>
          <div class="challenge-title">${c.title}</div>
          <div class="challenge-desc">${c.description || ''}</div>
        </div>
        <div class="challenge-days">${daysLeft}d left</div>
      </div>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" style="width:${progress}%;background:linear-gradient(90deg,var(--accent),var(--accent2))"></div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('challenges-list').innerHTML = html;
}

// ===== BUCKETS =====
function renderBuckets() {
  if (!buckets.length) {
    document.getElementById('buckets-list').innerHTML = '<div class="empty-state"><span class="empty-icon">ü™£</span><p>Create savings goals!</p></div>';
    return;
  }

  const html = buckets.map(b => {
    const progress = Math.min(100, (b.current_amount / b.target_amount) * 100);
    return `
    <div class="bucket-card">
      <div class="bucket-header">
        <div class="bucket-name-row">
          <span class="bucket-emoji">${b.icon || 'üéØ'}</span>
          <span class="bucket-name">${b.name}</span>
        </div>
        <div class="bucket-amounts">‚Çπ${parseFloat(b.current_amount||0).toLocaleString('en-IN')} / ‚Çπ${parseFloat(b.target_amount).toLocaleString('en-IN')}</div>
      </div>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" style="width:${progress}%;background:linear-gradient(90deg,var(--green),var(--cyan))"></div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('buckets-list').innerHTML = html;
}

// ===== REMINDERS =====
function renderReminders() {
  if (!reminders.length) {
    document.getElementById('reminders-list').innerHTML = '<div class="empty-state"><span class="empty-icon">‚è∞</span><p>No bill reminders set.</p></div>';
    return;
  }

  const html = reminders.map(r => {
    const due = new Date(r.due_date);
    const now = new Date();
    const daysUntil = Math.ceil((due - now) / (1000*60*60*24));
    const urgent = daysUntil <= 3;
    return `
    <div class="income-source-card" style="${urgent ? 'border-color:var(--red)' : ''}">
      <div class="income-icon">‚è∞</div>
      <div class="income-info">
        <div class="income-source">${r.title}</div>
        <div class="income-month" style="${urgent ? 'color:var(--red2)' : ''}">${urgent ? 'üö® ' : ''}Due ${due.toLocaleDateString()}</div>
      </div>
      <div class="income-amount" style="font-size:15px">‚Çπ${parseFloat(r.amount||0).toLocaleString('en-IN')}</div>
    </div>`;
  }).join('');
  document.getElementById('reminders-list').innerHTML = html;
}

// ===== INCOME LIST =====
function renderIncomeList() {
  if (!incomes.length) {
    document.getElementById('income-list-profile').innerHTML = '<div class="empty-state"><span class="empty-icon">üíµ</span><p>Add your income sources.</p></div>';
    return;
  }

  const sourceIcons = { parent_allowance: 'üë®‚Äçüë©‚Äçüëß', internship: 'üíº', part_time: '‚è∞', scholarship: 'üéì', other: 'üì¶' };
  const html = incomes.slice(0,5).map(i => `
    <div class="income-source-card">
      <div class="income-icon">${sourceIcons[i.source] || 'üíµ'}</div>
      <div class="income-info">
        <div class="income-source">${i.source.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())}</div>
        <div class="income-month">${i.month_year} ${i.description ? '¬∑ '+i.description : ''}</div>
      </div>
      <div class="income-amount">‚Çπ${parseFloat(i.amount).toLocaleString('en-IN')}</div>
    </div>
  `).join('');
  document.getElementById('income-list-profile').innerHTML = html;
}

// ===== PERSONALITY =====
function updatePersonality() {
  const totalSpent = expenses.reduce((s,e) => s + parseFloat(e.amount || 0), 0);
  const impulsive = expenses.filter(e => e.mood === 'regret' || e.category === 'shopping' || e.category === 'entertainment').length;
  const ratio = expenses.length > 0 ? impulsive / expenses.length : 0;
  
  let type, emoji, desc;
  if (ratio > 0.5) {
    type = 'Impulsive Spender'; emoji = 'üõçÔ∏è';
    desc = 'You tend to spend emotionally. Try a 24-hour rule before purchases. You can turn this around!';
  } else if (ratio < 0.2) {
    type = 'Extreme Saver'; emoji = 'üè¶';
    desc = 'You\'re very disciplined with money! Balance is key ‚Äî it\'s okay to enjoy a little too.';
  } else {
    type = 'Balanced Spender'; emoji = '‚öñÔ∏è';
    desc = 'You have a healthy relationship with money! Keep building your savings habit.';
  }
  
  document.getElementById('personality-emoji').textContent = emoji;
  document.getElementById('personality-type').textContent = type;
  document.getElementById('personality-desc').textContent = desc;

  if (userProfile) {
    sb.from('profiles').update({ money_personality: type.toLowerCase().replace(/ /g,'_') }).eq('id', currentUser.id);
  }
}

// ===== EXPENSE RENDERING =====
function renderExpenseItem(e) {
  const cat = catConfig[e.category] || catConfig.other;
  const date = new Date(e.expense_date || e.created_at);
  const dateStr = date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
  return `
    <div class="expense-item">
      <div class="expense-icon cat-${e.category}">${cat.icon}</div>
      <div class="expense-info">
        <div class="expense-name">${e.description || e.category}</div>
        <div class="expense-meta">${e.category} ¬∑ ${dateStr} ${e.mood ? '¬∑ '+e.mood : ''}</div>
      </div>
      <div class="expense-amount">-‚Çπ${parseFloat(e.amount).toLocaleString('en-IN')}</div>
    </div>`;
}

function renderRecentExpenses() {
  const recent = expenses.slice(0, 5);
  if (!recent.length) {
    document.getElementById('recent-expenses-list').innerHTML = '<div class="empty-state"><span class="empty-icon">üßæ</span><p>No expenses yet. Add your first one!</p></div>';
    return;
  }
  document.getElementById('recent-expenses-list').innerHTML = recent.map(renderExpenseItem).join('');
}

// ===== ANALYTICS =====
function setAnalyticsPeriod(period, btn) {
  analyticsPeriod = period;
  document.querySelectorAll('.pill-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderAnalytics();
}

function getFilteredExpenses() {
  const now = new Date();
  return expenses.filter(e => {
    const d = new Date(e.expense_date || e.created_at);
    if (analyticsPeriod === 'month') return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
    if (analyticsPeriod === 'week') {
      const weekAgo = new Date(now); weekAgo.setDate(weekAgo.getDate()-7);
      return d >= weekAgo;
    }
    return true;
  });
}

function renderAnalytics() {
  const filtered = getFilteredExpenses();

  // Category chart
  const catTotals = {};
  filtered.forEach(e => {
    catTotals[e.category] = (catTotals[e.category] || 0) + parseFloat(e.amount || 0);
  });

  const labels = Object.keys(catTotals);
  const data = Object.values(catTotals);
  const colors = labels.map(l => catConfig[l]?.color || '#64748b');

  if (categoryChartInstance) categoryChartInstance.destroy();
  const ctx1 = document.getElementById('categoryChart').getContext('2d');
  categoryChartInstance = new Chart(ctx1, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor: colors.map(c => c+'cc'), borderColor: colors, borderWidth: 2 }] },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'right', labels: { color: '#9090b0', font: { size: 12, family: 'DM Sans' }, boxWidth: 12, padding: 16 } }
      }
    }
  });

  // Trend chart - last 14 days
  const days = [];
  const dayAmounts = [];
  for (let i = 13; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const key = d.toISOString().split('T')[0];
    days.push(d.getDate() + '/' + (d.getMonth()+1));
    const total = expenses.filter(e => (e.expense_date || e.created_at?.split('T')[0]) === key)
      .reduce((s,e) => s + parseFloat(e.amount || 0), 0);
    dayAmounts.push(total);
  }

  if (trendChartInstance) trendChartInstance.destroy();
  const ctx2 = document.getElementById('trendChart').getContext('2d');
  trendChartInstance = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: days,
      datasets: [{
        label: 'Daily Spend',
        data: dayAmounts,
        backgroundColor: 'rgba(124,58,237,0.5)',
        borderColor: '#7c3aed',
        borderWidth: 1,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#9090b0', font: { size: 10 } }, grid: { color: '#2a2a3e' } },
        y: { ticks: { color: '#9090b0', font: { size: 11 } }, grid: { color: '#2a2a3e' } }
      }
    }
  });

  // Heatmap
  const heatEl = document.getElementById('heatmap-grid');
  let heatHtml = '';
  for (let i = 29; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const key = d.toISOString().split('T')[0];
    const total = expenses.filter(e => (e.expense_date || e.created_at?.split('T')[0]) === key)
      .reduce((s,e) => s + parseFloat(e.amount || 0), 0);
    let cls = '';
    if (total > 500) cls = 'h4';
    else if (total > 200) cls = 'h3';
    else if (total > 50) cls = 'h2';
    else if (total > 0) cls = 'h1';
    heatHtml += `<div class="heatmap-cell ${cls}" title="${d.toDateString()}: ‚Çπ${total}"></div>`;
  }
  heatEl.innerHTML = heatHtml;

  // All expenses list
  const allEl = document.getElementById('all-expenses-list');
  if (!filtered.length) {
    allEl.innerHTML = '<div class="empty-state"><span class="empty-icon">üßæ</span><p>No expenses in this period.</p></div>';
  } else {
    allEl.innerHTML = filtered.map(renderExpenseItem).join('');
  }
}

// ===== LEADERBOARD =====
async function renderLeaderboard() {
  const { data } = await sb.from('gamification').select('user_id, total_points, current_streak, level_name').order('total_points', { ascending: false }).limit(10);
  if (!data || !data.length) {
    document.getElementById('leaderboard-list').innerHTML = '<div class="empty-state"><span class="empty-icon">üèÜ</span><p>Be the first on the leaderboard!</p></div>';
    return;
  }

  const emojis = ['üòé','üéì','üí°','üåü','‚ö°','üî•','üí™','üöÄ','üëë','üíé'];
  const html = data.map((u, i) => `
    <div class="leaderboard-item">
      <div class="leaderboard-rank rank-${i+1}">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i+1}</div>
      <div class="lb-avatar">${emojis[i % emojis.length]}</div>
      <div class="lb-info">
        <div class="lb-name">${u.user_id === currentUser.id ? 'You üëà' : 'Student ' + (i+1)}</div>
        <div class="lb-score">${u.total_points} XP ¬∑ üî•${u.current_streak} streak</div>
      </div>
    </div>
  `).join('');
  document.getElementById('leaderboard-list').innerHTML = html;
}

// ===== ADD EXPENSE =====
async function addExpense() {
  const amount = parseFloat(document.getElementById('exp-amount').value);
  const desc = document.getElementById('exp-desc').value.trim();

  if (!amount || amount <= 0) { showToast('‚ö†Ô∏è', 'Invalid Amount', 'Please enter a valid amount'); return; }

  const { error } = await sb.from('expenses').insert({
    user_id: currentUser.id,
    category: selectedCategory,
    amount,
    description: desc,
    mood: selectedMood,
    expense_date: new Date().toISOString().split('T')[0]
  });

  if (error) { showToast('‚ùå', 'Error', error.message); return; }

  // Award points
  await awardPoints(50, 'Expense logged');
  await checkAndAwardBadge('first_expense');
  if (expenses.length + 1 >= 5) await checkAndAwardBadge('five_expenses');
  if (expenses.length + 1 >= 10) await checkAndAwardBadge('ten_expenses');

  // Reload and update
  await loadUserData();
  updateUI();
  closeModal('expense-modal');
  showToast('‚úÖ', 'Expense Added', `‚Çπ${amount} for ${desc || selectedCategory}`);
  spawnCoin('+50 XP');

  // Reset form
  document.getElementById('exp-amount').value = '';
  document.getElementById('exp-desc').value = '';
  selectedCategory = 'other';
  selectedMood = 'neutral';
  document.querySelectorAll('.cat-option').forEach(b => b.classList.remove('selected'));
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
}

// ===== AUTO CATEGORIZE =====
function autoCateg() {
  const desc = document.getElementById('exp-desc').value.toLowerCase();
  const rules = {
    food: ['food', 'lunch', 'dinner', 'breakfast', 'zomato', 'swiggy', 'restaurant', 'chai', 'coffee', 'snack', 'meal', 'dosa', 'biryani', 'pizza', 'burger'],
    travel: ['uber', 'ola', 'bus', 'metro', 'train', 'auto', 'rickshaw', 'fare', 'ticket', 'travel', 'cab'],
    education: ['book', 'course', 'class', 'tuition', 'stationery', 'pen', 'notebook', 'study'],
    shopping: ['amazon', 'flipkart', 'clothes', 'shirt', 'shoes', 'myntra', 'shopping', 'mall'],
    entertainment: ['netflix', 'hotstar', 'movie', 'game', 'spotify', 'concert', 'pub', 'party'],
    health: ['medicine', 'doctor', 'hospital', 'pharmacy', 'gym', 'medical'],
    rent: ['rent', 'pg', 'hostel', 'accommodation'],
    subscription: ['subscription', 'membership', 'prime', 'premium', 'monthly plan'],
  };
  
  for (const [cat, kws] of Object.entries(rules)) {
    if (kws.some(kw => desc.includes(kw))) {
      selectedCategory = cat;
      document.querySelectorAll('.cat-option').forEach(b => {
        b.classList.toggle('selected', b.dataset.cat === cat);
      });
      break;
    }
  }
}

// ===== ADD INCOME =====
async function addIncome() {
  const source = document.getElementById('inc-source').value;
  const amount = parseFloat(document.getElementById('inc-amount').value);
  const desc = document.getElementById('inc-desc').value.trim();

  if (!amount || amount <= 0) { showToast('‚ö†Ô∏è', 'Invalid Amount', 'Please enter a valid amount'); return; }

  const now = new Date();
  const monthYear = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

  const { error } = await sb.from('incomes').insert({
    user_id: currentUser.id, source, amount, description: desc, month_year: monthYear
  });

  if (error) { showToast('‚ùå', 'Error', error.message); return; }

  await awardPoints(100, 'Income added');
  await checkAndAwardBadge('income_added');
  await loadUserData();
  updateUI();
  closeModal('income-modal');
  showToast('üíµ', 'Income Added', `‚Çπ${amount} from ${source.replace(/_/g,' ')}`);
  spawnCoin('+100 XP');
}

// ===== UPDATE BUDGET =====
async function updateBudget() {
  const amount = parseFloat(document.getElementById('budget-input').value);
  if (!amount || amount <= 0) { showToast('‚ö†Ô∏è', 'Invalid', 'Enter a valid budget'); return; }
  await sb.from('profiles').update({ monthly_budget: amount }).eq('id', currentUser.id);
  userProfile.monthly_budget = amount;
  updateUI();
  closeModal('budget-modal');
  showToast('‚úÖ', 'Budget Updated', `Monthly budget set to ‚Çπ${amount.toLocaleString('en-IN')}`);
}

// ===== ADD CHALLENGE =====
let challengeData = {};

function selectChallenge(btn, title, desc, target, daily, days) {
  document.querySelectorAll('#challenge-modal .cat-option').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  challengeData = { title, desc, target, daily, days };
  document.getElementById('chal-title').value = title;
  document.getElementById('chal-days').value = days;
}

async function addChallenge() {
  const title = document.getElementById('chal-title').value.trim() || challengeData.title;
  const days = parseInt(document.getElementById('chal-days').value) || 7;
  if (!title) { showToast('‚ö†Ô∏è', 'Missing', 'Enter a challenge title'); return; }

  const start = new Date();
  const end = new Date(); end.setDate(end.getDate() + days);

  await sb.from('challenges').insert({
    user_id: currentUser.id,
    title,
    description: challengeData.desc || '',
    target_amount: challengeData.target,
    daily_limit: challengeData.daily,
    duration_days: days,
    start_date: start.toISOString().split('T')[0],
    end_date: end.toISOString().split('T')[0]
  });

  await awardPoints(50, 'Challenge started');
  await loadUserData();
  updateUI();
  closeModal('challenge-modal');
  showToast('üéØ', 'Challenge Started!', title);
}

// ===== ADD BUCKET =====
async function addBucket() {
  const name = document.getElementById('bucket-name').value.trim();
  const target = parseFloat(document.getElementById('bucket-target').value);
  if (!name || !target) { showToast('‚ö†Ô∏è', 'Missing', 'Fill all fields'); return; }
  
  await sb.from('savings_buckets').insert({ user_id: currentUser.id, name, target_amount: target, icon: selectedBucketIcon });
  await loadUserData();
  updateUI();
  closeModal('bucket-modal');
  showToast('ü™£', 'Goal Created!', `${name} ‚Äî Target: ‚Çπ${target.toLocaleString('en-IN')}`);
}

// ===== ADD REMINDER =====
async function addReminder() {
  const title = document.getElementById('rem-title').value.trim();
  const amount = parseFloat(document.getElementById('rem-amount').value);
  const date = document.getElementById('rem-date').value;
  if (!title || !date) { showToast('‚ö†Ô∏è', 'Missing', 'Fill required fields'); return; }
  
  await sb.from('bill_reminders').insert({ user_id: currentUser.id, title, amount: amount||0, due_date: date });
  await loadUserData();
  updateUI();
  closeModal('reminder-modal');
  showToast('‚è∞', 'Reminder Set!', `${title} due ${new Date(date).toLocaleDateString()}`);
}

// ===== STREAK SYSTEM =====
async function checkDailyStreak() {
  if (!userGamification) return;
  const today = new Date().toISOString().split('T')[0];
  const last = userGamification.last_logged_date;
  
  if (last === today) return; // Already logged today

  const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
  const yStr = yesterday.toISOString().split('T')[0];
  
  let newStreak = last === yStr ? (userGamification.current_streak || 0) + 1 : 1;
  const longest = Math.max(newStreak, userGamification.longest_streak || 0);

  await sb.from('gamification').update({
    current_streak: newStreak,
    longest_streak: longest,
    last_logged_date: today
  }).eq('user_id', currentUser.id);

  userGamification.current_streak = newStreak;
  userGamification.longest_streak = longest;

  if (newStreak >= 3) await checkAndAwardBadge('streak_3');
  if (newStreak >= 7) await checkAndAwardBadge('streak_7');

  await awardPoints(20, 'Daily login');
  if (newStreak > 1) showToast('üî•', `${newStreak} Day Streak!`, 'Keep it up! +20 XP');
}

// ===== POINTS & BADGES =====
async function awardPoints(pts, reason) {
  if (!userGamification) return;
  const newTotal = (userGamification.total_points || 0) + pts;
  const newCoins = (userGamification.coins || 0) + Math.floor(pts/10);
  
  await sb.from('gamification').update({ total_points: newTotal, coins: newCoins }).eq('user_id', currentUser.id);
  await sb.from('points_log').insert({ user_id: currentUser.id, points: pts, reason });
  
  userGamification.total_points = newTotal;
  userGamification.coins = newCoins;
  updateNavStats();
  updateGamificationUI();
}

async function checkAndAwardBadge(key) {
  const already = achievements.find(a => a.badge_key === key);
  if (already) return;
  
  const badge = allBadges.find(b => b.key === key);
  if (!badge) return;

  await sb.from('achievements').insert({
    user_id: currentUser.id,
    badge_key: key,
    badge_name: badge.name,
    badge_description: badge.desc,
    badge_icon: badge.icon
  });

  achievements.push({ badge_key: key, ...badge });
  await awardPoints(200, `Badge earned: ${badge.name}`);
  showToast(badge.icon, `Badge Unlocked!`, badge.name);
  renderBadges();
}

// ===== AI CHAT =====
function setChatMode(mode, btn) {
  chatMode = mode;
  document.querySelectorAll('.chat-mode-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

async function sendChat() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  
  input.value = '';
  input.style.height = 'auto';
  addChatBubble(msg, 'user');
  chatHistory.push({ role: 'user', content: msg });

  // Save to DB
  await sb.from('chat_history').insert({ user_id: currentUser.id, role: 'user', content: msg, mode: chatMode });

  // Build context
  const totalSpent = expenses.reduce((s,e) => s + parseFloat(e.amount||0), 0);
  const budget = parseFloat(userProfile?.monthly_budget || 0);
  const balance = budget - totalSpent;
  const systemPrompts = {
    finance_coach: `You are a friendly AI finance coach for a student in India. The student has a monthly budget of ‚Çπ${budget}, has spent ‚Çπ${totalSpent.toFixed(0)} so far this month, and has ‚Çπ${balance.toFixed(0)} remaining. Streak: ${userGamification?.current_streak || 0} days. Give concise, actionable advice. Use rupee (‚Çπ) symbol. Be encouraging!`,
    expense_assistant: `You are an expense management assistant for an Indian student. Budget: ‚Çπ${budget}/month. Spent: ‚Çπ${totalSpent.toFixed(0)}. Balance: ‚Çπ${balance.toFixed(0)}. Answer expense and budget questions concisely.`,
    motivation: `You are a motivational finance coach for a student. Be enthusiastic and encouraging! They have a ${userGamification?.current_streak || 0} day streak. Budget: ‚Çπ${budget}. Help them stay motivated about saving money. Use emojis and be energetic!`
  };

  const typingBubble = addTypingIndicator();

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 500,
        system: systemPrompts[chatMode],
        messages: chatHistory.slice(-10)
      })
    });
    
    const data = await response.json();
    typingBubble.remove();
    
    if (data.content?.[0]?.text) {
      const reply = data.content[0].text;
      addChatBubble(reply, 'assistant');
      chatHistory.push({ role: 'assistant', content: reply });
      await sb.from('chat_history').insert({ user_id: currentUser.id, role: 'assistant', content: reply, mode: chatMode });
    } else {
      addChatBubble('I\'m here to help with your finances! Ask me about budgeting, saving tips, or spending habits. üí∞', 'assistant');
    }
  } catch (err) {
    typingBubble.remove();
    addChatBubble('I\'m offline right now, but here\'s a tip: Track every expense, no matter how small! Small leaks sink big ships. üí°', 'assistant');
  }
}

function addChatBubble(text, role) {
  const container = document.getElementById('chat-messages');
  const bubble = document.createElement('div');
  bubble.className = `chat-bubble ${role}`;
  bubble.textContent = text;
  container.appendChild(bubble);
  container.scrollTop = container.scrollHeight;
  return bubble;
}

function addTypingIndicator() {
  const container = document.getElementById('chat-messages');
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble assistant';
  bubble.textContent = '...';
  bubble.style.opacity = '0.6';
  container.appendChild(bubble);
  container.scrollTop = container.scrollHeight;
  return bubble;
}

// ===== GAMES =====
function startGame(type) {
  document.getElementById('game-overlay').classList.add('open');
  document.getElementById('current-score').textContent = '0';
  currentGame = type;
  gameActive = true;

  const container = document.getElementById('game-canvas-container');
  container.innerHTML = '';

  if (type === 'money_catch') startMoneyCatch(container);
  else if (type === 'budget_quiz') startBudgetQuiz(container);
  else if (type === 'reaction_speed') startReactionGame(container);

  checkAndAwardBadge('game_player');
}

function closeGame() {
  gameActive = false;
  document.getElementById('game-overlay').classList.remove('open');
  document.getElementById('game-canvas-container').innerHTML = '';
  currentGame = null;
}

// MONEY CATCH GAME
function startMoneyCatch(container) {
  document.getElementById('game-title').textContent = 'ü™ô Money Catch';
  
  const canvas = document.createElement('canvas');
  canvas.width = Math.min(380, window.innerWidth - 40);
  canvas.height = Math.min(500, window.innerHeight - 200);
  container.appendChild(canvas);

  const ctx = canvas.getContext('2d');
  let score = 0;
  let lives = 3;
  let items = [];
  let playerX = canvas.width / 2;
  let frameCount = 0;
  let speed = 2;

  const player = { w: 60, h: 20, color: '#7c3aed' };

  // Touch/mouse controls
  canvas.addEventListener('mousemove', e => {
    const rect = canvas.getBoundingClientRect();
    playerX = e.clientX - rect.left;
  });
  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    playerX = e.touches[0].clientX - rect.left;
  }, { passive: false });

  function spawnItem() {
    const isCoin = Math.random() > 0.35;
    items.push({
      x: Math.random() * (canvas.width - 30) + 15,
      y: -20,
      emoji: isCoin ? ['üí∞','ü™ô','üíµ'][Math.floor(Math.random()*3)] : ['üí∏','üìâ','üõçÔ∏è','üé∞'][Math.floor(Math.random()*4)],
      isCoin,
      speed: speed + Math.random() * 2,
      size: 28
    });
  }

  function gameLoop() {
    if (!gameActive || currentGame !== 'money_catch') return;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#0a0a0f';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    frameCount++;
    if (frameCount % 60 === 0) { spawnItem(); speed = Math.min(6, speed + 0.05); }

    // Draw player
    ctx.fillStyle = '#7c3aed';
    ctx.beginPath();
    ctx.roundRect(playerX - player.w/2, canvas.height - 40, player.w, player.h, 8);
    ctx.fill();
    ctx.fillStyle = 'white';
    ctx.font = '16px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ü§è', playerX, canvas.height - 26);

    // Update and draw items
    items = items.filter(item => {
      item.y += item.speed;
      ctx.font = `${item.size}px sans-serif`;
      ctx.textAlign = 'center';
      ctx.fillText(item.emoji, item.x, item.y);

      // Collision check
      if (item.y > canvas.height - 50 && Math.abs(item.x - playerX) < player.w/2 + 10) {
        if (item.isCoin) { score += 10; document.getElementById('current-score').textContent = score; }
        else { lives--; if (lives <= 0) { endGame(score); return false; } }
        return false;
      }
      if (item.y > canvas.height + 20) {
        if (item.isCoin) { /* missed */ }
        return false;
      }
      return true;
    });

    // HUD
    ctx.fillStyle = '#e8e8f0';
    ctx.font = 'bold 16px Space Mono, monospace';
    ctx.textAlign = 'left';
    ctx.fillText('‚ù§Ô∏è'.repeat(lives), 10, 25);
    ctx.textAlign = 'right';
    ctx.fillText('‚Çπ' + score, canvas.width - 10, 25);

    requestAnimationFrame(gameLoop);
  }

  spawnItem(); spawnItem();
  gameLoop();
}

async function endGame(score) {
  gameActive = false;
  const type = currentGame;
  
  await sb.from('game_scores').insert({ user_id: currentUser.id, game_type: type, score });
  await awardPoints(Math.floor(score/10), `Game: ${type}`);
  
  const container = document.getElementById('game-canvas-container');
  container.innerHTML = `
    <div style="text-align:center;padding:20px">
      <div style="font-size:64px;margin-bottom:16px">üéÆ</div>
      <div style="font-family:'Syne',sans-serif;font-size:32px;font-weight:800;margin-bottom:8px">Game Over!</div>
      <div style="font-size:24px;color:var(--yellow);font-family:'Space Mono',monospace;margin-bottom:8px">Score: ${score}</div>
      <div style="color:var(--text2);margin-bottom:24px">+${Math.floor(score/10)} XP earned</div>
      <button class="btn-primary" style="width:auto;padding:12px 28px" onclick="startGame('${type}')">Play Again</button>
      <button class="btn-primary" style="width:auto;padding:12px 28px;margin-left:10px;background:var(--card);border:1px solid var(--border);color:var(--text)" onclick="closeGame()">Exit</button>
    </div>`;
  
  showToast('üéÆ', 'Game Over!', `Score: ${score} ¬∑ +${Math.floor(score/10)} XP`);
}

// BUDGET QUIZ
const quizQuestions = [
  { q: "What is the 50/30/20 rule?", opts: ["50% needs, 30% wants, 20% savings", "50% food, 30% rent, 20% fun", "50% savings, 30% needs, 20% wants", "50% wants, 30% savings, 20% needs"], ans: 0 },
  { q: "You have ‚Çπ200 left for 5 days. Safe daily limit?", opts: ["‚Çπ40", "‚Çπ50", "‚Çπ100", "‚Çπ200"], ans: 0 },
  { q: "Which is NOT a good saving habit?", opts: ["Pay yourself first", "Track every expense", "Buy on impulse", "Set savings goals"], ans: 2 },
  { q: "What is an emergency fund?", opts: ["Fun money", "3-6 months of expenses saved", "Investment account", "Credit card limit"], ans: 1 },
  { q: "Best time to review your budget?", opts: ["Once a year", "Weekly or monthly", "Never, it's boring", "When you run out"], ans: 1 },
  { q: "The cheapest meal option for students?", opts: ["Restaurant every day", "Food delivery apps", "Cooking at home", "Skipping meals"], ans: 2 },
  { q: "What is lifestyle inflation?", opts: ["Eating more expensive food", "Spending more as income rises", "Price increases over time", "Buying luxury brands"], ans: 1 },
  { q: "Good way to avoid impulsive buying?", opts: ["Keep card details saved", "Shop while hungry", "Wait 24 hours before buying", "Browse deals daily"], ans: 2 },
  { q: "What reduces monthly expenses the most?", opts: ["Cutting one big expense", "Saving ‚Çπ5 here and there", "Switching to cheaper phone", "Using public transport"], ans: 0 },
  { q: "Best investment for a student?", opts: ["Luxury watch", "Skill development courses", "Expensive gadgets", "Premium subscriptions"], ans: 1 }
];

function startBudgetQuiz(container) {
  document.getElementById('game-title').textContent = 'üß† Budget Quiz';
  let qIndex = 0;
  let score = 0;
  let shuffled = [...quizQuestions].sort(() => Math.random() - 0.5);

  function showQuestion() {
    if (qIndex >= shuffled.length) {
      endQuiz(score, container); return;
    }
    const q = shuffled[qIndex];
    container.innerHTML = `
      <div class="quiz-container" style="max-width:480px;width:100%;padding:20px">
        <div style="text-align:center;font-size:13px;color:var(--text2);margin-bottom:16px">${qIndex+1} / ${shuffled.length}</div>
        <div class="progress-bar-bg" style="margin-bottom:20px"><div class="progress-bar-fill" style="width:${(qIndex/shuffled.length)*100}%;background:linear-gradient(90deg,var(--accent),var(--cyan))"></div></div>
        <div class="quiz-question">${q.q}</div>
        <div class="quiz-options">
          ${q.opts.map((o,i) => `<button class="quiz-option" onclick="answerQuiz(${i},${q.ans},this)">${o}</button>`).join('')}
        </div>
      </div>`;
    document.getElementById('current-score').textContent = score;
  }

  window.answerQuiz = function(chosen, correct, btn) {
    document.querySelectorAll('.quiz-option').forEach(b => b.style.pointerEvents = 'none');
    if (chosen === correct) {
      btn.classList.add('correct');
      score++;
      document.getElementById('current-score').textContent = score;
    } else {
      btn.classList.add('wrong');
      document.querySelectorAll('.quiz-option')[correct].classList.add('correct');
    }
    setTimeout(() => { qIndex++; showQuestion(); }, 1200);
  };

  showQuestion();
}

async function endQuiz(score, container) {
  await sb.from('game_scores').insert({ user_id: currentUser.id, game_type: 'budget_quiz', score });
  await awardPoints(score * 30, 'Budget quiz');
  if (score === 10) await checkAndAwardBadge('quiz_perfect');
  
  const grade = score >= 9 ? 'üèÜ Genius!' : score >= 7 ? 'üåü Great!' : score >= 5 ? 'üëç Good!' : 'üìö Keep Learning!';
  container.innerHTML = `
    <div style="text-align:center;padding:20px">
      <div style="font-size:64px;margin-bottom:16px">${score >= 7 ? 'üèÜ' : 'üìö'}</div>
      <div style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;margin-bottom:8px">${grade}</div>
      <div style="font-size:56px;font-family:'Space Mono',monospace;color:var(--yellow);margin:16px 0">${score}/${quizQuestions.length}</div>
      <div style="color:var(--text2);margin-bottom:24px">+${score*30} XP earned</div>
      <button class="btn-primary" style="width:auto;padding:12px 28px" onclick="startGame('budget_quiz')">Try Again</button>
      <button class="btn-primary" style="width:auto;padding:12px 28px;margin-left:10px;background:var(--card);border:1px solid var(--border);color:var(--text)" onclick="closeGame()">Exit</button>
    </div>`;
}

// REACTION GAME
function startReactionGame(container) {
  document.getElementById('game-title').textContent = '‚ö° Reaction Speed';
  let score = 0;
  let round = 0;
  let taps = [];
  let waiting = false;
  let targetVisible = false;
  let startTime = 0;
  const totalRounds = 8;

  function showRound() {
    if (round >= totalRounds) { endReactionGame(taps, container); return; }
    
    container.innerHTML = `
      <div style="text-align:center;padding:20px;width:100%">
        <div style="font-size:13px;color:var(--text2);margin-bottom:20px">Round ${round+1}/${totalRounds} ¬∑ Hit the coin when it appears!</div>
        <div id="reaction-status" style="font-size:16px;color:var(--text2);margin-bottom:30px">Get Ready...</div>
        <div style="display:flex;justify-content:center;align-items:center;height:160px">
          <div id="reaction-target" style="display:none" class="reaction-target" onclick="tapTarget()">ü™ô</div>
        </div>
      </div>`;

    waiting = true;
    const delay = 1000 + Math.random() * 2500;
    setTimeout(() => {
      if (!gameActive) return;
      document.getElementById('reaction-status').textContent = 'TAP NOW! ‚ö°';
      document.getElementById('reaction-status').style.color = 'var(--green2)';
      document.getElementById('reaction-target').style.display = 'flex';
      targetVisible = true;
      startTime = Date.now();
    }, delay);
  }

  window.tapTarget = function() {
    if (!targetVisible) return;
    const rt = Date.now() - startTime;
    taps.push(rt);
    targetVisible = false;
    document.getElementById('reaction-target').style.display = 'none';
    document.getElementById('reaction-status').textContent = `${rt}ms! ${rt < 300 ? '‚ö° Amazing!' : rt < 500 ? '‚úÖ Good!' : 'üòÖ Slow...'}`;
    document.getElementById('reaction-status').style.color = rt < 300 ? 'var(--yellow)' : rt < 500 ? 'var(--green2)' : 'var(--text2)';
    score += Math.max(0, 500 - rt);
    document.getElementById('current-score').textContent = score;
    round++;
    setTimeout(showRound, 1000);
  };

  showRound();
}

async function endReactionGame(taps, container) {
  const avg = Math.round(taps.reduce((a,b) => a+b, 0) / taps.length);
  await sb.from('game_scores').insert({ user_id: currentUser.id, game_type: 'reaction_speed', score: avg });
  await awardPoints(Math.max(0, Math.floor((500-avg)/5)), 'Reaction game');
  
  const grade = avg < 250 ? '‚ö° Lightning Fast!' : avg < 350 ? 'üöÄ Very Fast!' : avg < 450 ? 'üëç Good Reflexes' : 'üê¢ Keep Practicing!';
  container.innerHTML = `
    <div style="text-align:center;padding:20px">
      <div style="font-size:64px;margin-bottom:16px">‚ö°</div>
      <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;margin-bottom:8px">${grade}</div>
      <div style="font-size:16px;color:var(--text2);margin-bottom:8px">Average Reaction Time</div>
      <div style="font-size:48px;font-family:'Space Mono',monospace;color:var(--yellow);margin:12px 0">${avg}ms</div>
      <div style="color:var(--text2);margin-bottom:24px">Taps: ${taps.map(t=>t+'ms').join(' ¬∑ ')}</div>
      <button class="btn-primary" style="width:auto;padding:12px 28px" onclick="startGame('reaction_speed')">Try Again</button>
      <button class="btn-primary" style="width:auto;padding:12px 28px;margin-left:10px;background:var(--card);border:1px solid var(--border);color:var(--text)" onclick="closeGame()">Exit</button>
    </div>`;
}

// ===== AUTH =====
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(b => b.classList.remove('active'));
  document.querySelector(`.auth-tab:${tab === 'login' ? 'first-child' : 'last-child'}`).classList.add('active');
  document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('signup-form').style.display = tab === 'signup' ? 'block' : 'none';
  document.getElementById('auth-error').style.display = 'none';
}

async function handleLogin() {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if (error) { showAuthError(error.message); }
}

async function handleSignup() {
  const name = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value;
  const password = document.getElementById('signup-password').value;
  const budget = parseFloat(document.getElementById('signup-budget').value) || 0;

  if (!name || !email || !password) { showAuthError('Please fill all fields'); return; }

  const { data, error } = await sb.auth.signUp({
    email, password,
    options: { data: { full_name: name } }
  });
  
  if (error) { showAuthError(error.message); return; }

  if (budget && data.user) {
    setTimeout(async () => {
      await sb.from('profiles').update({ monthly_budget: budget, full_name: name }).eq('id', data.user.id);
    }, 2000);
  }
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.style.display = 'block';
}

async function handleLogout() {
  await sb.auth.signOut();
}

// ===== NAVIGATION =====
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  
  const navMap = { home: 0, analytics: 1, gamify: 2, chat: 3, games: 4, profile: -1 };
  const idx = navMap[name];
  if (idx >= 0) document.querySelectorAll('.nav-item')[idx].classList.add('active');

  if (name === 'analytics') renderAnalytics();
  if (name === 'gamify') { updateGamificationUI(); renderLeaderboard(); }
}

// ===== MODALS =====
function openModal(id) {
  document.getElementById(id).classList.add('open');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// ===== HELPERS =====
function selectCat(btn) {
  document.querySelectorAll('.cat-option').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedCategory = btn.dataset.cat;
}

function selectMood(btn) {
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedMood = btn.dataset.mood;
}

function selectBucketIcon(btn, icon) {
  document.querySelectorAll('#bucket-modal .mood-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedBucketIcon = icon;
}

function showToast(icon, title, desc) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerHTML = `
    <div class="toast-icon">${icon}</div>
    <div class="toast-text">
      <div class="toast-title">${title}</div>
      <div class="toast-desc">${desc}</div>
    </div>`;
  container.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 50);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3500);
}

function spawnCoin(text) {
  const el = document.createElement('div');
  el.className = 'coin-pop';
  el.textContent = text;
  el.style.left = Math.random() * 60 + 20 + '%';
  el.style.top = '30%';
  el.style.fontFamily = "'Syne', sans-serif";
  el.style.fontWeight = '700';
  el.style.color = '#f59e0b';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1000);
}

// ===== START =====
init();
</script>
</body>
</html>
